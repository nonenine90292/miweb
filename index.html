<!DOCTYPE html>
<!-- saved from url=(0018)https://monacomobile.ct.ws/# -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Eat cells smaller than you and don&#39;t get eaten by the bigger ones, as an MMO">
    <meta name="keywords" content="agario, agar, io, cell, cells, virus, bacteria, blob, game, games, web game, html5, fun, flash">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <title>Boobble.am</title>

    <link id="favicon" rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAEBUlEQVR4AcRVTWxTRxCe3edQWqD/tHKaVnGoACeHqq1oD+VaEEeQ4IwENyROIBSBcgDEBcQFjlyQOBEJOALncAAEiEMSEISXiGAD4ichIuHHb5fve/Ga9cZ2fhyE5XkzO7PzzTez62ctn/kzbwIDrbn/+7PtRwazuT5oS4F9bbA1dxKxHQPZ3/+aT09zIgDwDf3Z3NmBbPtja+1lFOg2Yv+DTr+w1xlrdyF2ykrpBgj1MScNzvJoSOBhW9uXd1pzRwF+ScRutSI/z4KXhg3IMYe5xEiddR51CdzNrto8kWT6Emv31Mmd1c1cYhCr3uaaBPpxxiVJzqHjGefZopQs11q+05H8FGVkJeRb2F8pLRmlJPwQg1jEDGNczyBQZtvNoC8RwL9HoR8gy1HsC6yZHGHTUthfg9SPiDFeiwi2dZexYX78EqOy4nklkhyoOMoGu1sJ8CUoVHbVVZwQiSwDyXATsVnD91cReG1aDnJk/gaOl935vrnYKzAR5vp7ic0avq9CgD+bJLhw7ILj9RPmYzOX0/NzWIO1nK9CwFjZ6ZzUPEd2QbsZ4fR4f6owrPS4dYWAErvOOam/qXGG9C9EQiy+J/rb2v8lVkpg8JeO1Tifdjoo7J6XifZiCC9viKfNdMMpAWvNn36hJTLz9+zHF2LzZ+vnGYn+5rpMQP3DhRMydvZi6ZagKW1t2nRKAI/0PFyxcFzO34wOMXEP/iAeauNvRskkF59DUgLKyF2/+Htr/eWi2CGmFnWbwJoP0aaKwLtPQUCqmzJK3WLtlIAxmSEunLwLNjt/M/pt0JSW5AbxUgJLM/Y+F05K2ByOzMUWojnREM9odZ1YKYFVow/uaVFX6HAybo0zm9YhFt4ycdfo8FUCaz5SUXIw1eUHpzBhmifxChj4AyqjTiu89k9OWyIVAvlCfBl/GsdcgPo1pvAGx0F7IcLcSWBU56refHHkuPNVCNCxTL/vUSI3aTsZM4mwi+o77KK1Nec2js7HkOvvAHYcGbPP91UR+HV0dCqS6LC/gTa7eAEw3mSC01dPpjCx59g7NaNzvPBE9ax9MhL7udpf0F5THDqvRR2h7Qtv8UsAP01KwgLj6HASxUiKRzWG9TPExyHhmROHmF3F+AxtX7S/cHa+GO/PSLQFI6s6DhcnGXb4CsVIagLF36BjXly3x2liEIuYzufrmgS4gZNYEZXWhxeTsbkKc4lBrHo5dQkwgXdibSHeq5XaKKJ6ReQhpOEXHeOMVS9zmEuMRgkNCbhE/kRxftu6isO/tYjt1Drarq06ofnyUnJRKXUoo6LNkbEdncXhDu5ljstvpHWjYK3Y6uLIYP7R0On843g3znV9V2F4U2ch7llTGLoQ3nDmzyYfAAAA//8dUfvpAAAABklEQVQDALNZmVARIP+CAAAAAElFTkSuQmCC">
    <link href="./bubble.am_files/css" rel="stylesheet" type="text/css">
    <link href="./bubble.am_files/bootstrap.min.css" rel="stylesheet">
    <link href="./bubble.am_files/index.css" rel="stylesheet">
    <link rel="stylesheet" href="./bubble.am_files/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" href="./bubble.am_files/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>-->
    <script async="" src="./bubble.am_files/js"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-86W17CQC94');
    </script>
    <script src="./bubble.am_files/jquery.js.descarga"></script>
    <script src="./bubble.am_files/log.js.descarga"></script>
    <script src="./bubble.am_files/vector.js.descarga"></script>
    
    <script>
      var lang_play = "Play";
      var busy = false;

      $(document).ready(function () {
        $("#gamemode").on("change", function () {
          if (this.value == ":5" || this.value == ":11") {
            $("#radio_mode").find("input[type=radio]").prop("checked", false);
            switch (this.value) {
              //case ":3": $('#radio_mode .radio-ffa, #radio_mode .radio-battle').hide(); $('#radio_mode .radio-teams').show(); break;
              case ":11":
                $("#radio_mode .radio-ffa, #radio_mode .radio-teams").hide();
                $("#radio_mode .radio-battle").show();
                break;
              default:
                $("#radio_mode .radio-ffa").show();
                $("#radio_mode .radio-battle, #radio_mode .radio-teams").hide();
                break;
            }
            $("#radio_mode").css("display", "block");
          } else {
            $("#radio_mode").css("display", "none");
          }

          if (this.value == ":11") {
            if ($("#playBtn").hasClass("btn-primary"))
              $("#playBtn")
                .toggleClass("btn-primary btn-danger")
                .html(
                  '<span class="spinner"><i class="fa fa-spinner fa-spin"></i></span> ' +
                    lang_play
                );

            if (logged) {
              $(".showFriends").hide();
              $("#playBtn").css("width", "86%");
            }
          } else {
            if (logged) {
              $("#playBtn").css("width", "73%");
              $(".showFriends").show();
            }
            if ($("#playBtn").hasClass("btn-danger"))
              $("#playBtn")
                .toggleClass("btn-danger btn-primary")
                .html(lang_play);
            setGameMode(this.value);
          }
        });

        $("#playBtn").on("click", function (event) {
          event.preventDefault();
          if ($("#playBtn").hasClass("btn-primary") && 
    !["10", "11", "12"].includes($("#gamemode").val().substring(1))) {
  setNick(document.getElementById("nick").value);
          } else if (
            $("#gamemode").val() == ":10" ||
            $("input[name=mode_type]:checked", "#radio_mode").val() > 10
          ) {
            if ($("#gamemode").val() == ":10") {
              if (beforeExit() == " ") {
                setNick(document.getElementById("nick").value);
              } else {
                $("#playBtn").prop("disabled", true);
              }
            } else {
              setGameMode(":11", 1);
              createBattleServer(
                $("input[name=mode_type]:checked", "#radio_mode").val()
              );
            }
          }
        });
      });
    </script>
    <script>

            (function (wHandle, wjQuery) {
      ONLY_CLIENT = false;
      var CONNECTION_URL = location.host;
      (SKIN_URL = "./skins/"), // Skin Directory
        (STATS = "");

      var touchX,
        touchY,
        touchable = "createTouch" in document,
        touches = [];

      var leftTouchID = -1,
        leftTouchPos = new Vector2(0, 0),
        leftTouchStartPos = new Vector2(0, 0),
        leftVector = new Vector2(0, 0);

      var useHttps = "https:" == wHandle.location.protocol;
      var notiBoard = [];
      var player_id = 11384;
      var bubLogged = false;
      var battlec = false;
      var sent2battle = false;
      var lastacti = Date.now();
      var lT = null;
      let s = 1;            
      let lastUpdate = Date.now(); 
      wHandle.bubbleSend = bubbleSend;


      wHandle.lastUserAct = function lastusract() {
        return parseInt((Date.now() - lastacti) / 1000);
      };
      wHandle.playsound = function playsound(mp3) {
        wjQuery("#audiomp3").remove();
        setTimeout(function () {
          wjQuery("body").append(
            '<audio id="audiomp3" autoplay><source src="sounds/' +
              mp3 +
              '" type="audio/mpeg"></audio>'
          );
        }, 500);
      };
      wHandle.onmousemove = function onmousemove() {
        lastacti = Date.now();
      };
      wHandle.onmousedown = function onmousedown() {
        lastacti = Date.now();
      };
      function bubbleSend(sendto, str) {
       if (bubbleRunning() && str.length < 100 && str.length > 0) {
         var msg = new DataView(new ArrayBuffer(6 + 2 * str.length));
     
         msg.setUint8(0, 99);
         msg.setUint32(1, parseInt(sendto), true);
     
         var offset = 6;
         for (var i = 0; i < str.length; ++i) {
           msg.setUint16(offset, str.charCodeAt(i), true);
           offset += 2;
         }
        bubSend(msg);
       }
     }
      var bubsrv = "wss://monacomobile.ct.ws/ws/";

      setTimeout(function () {
        bConnect(bubsrv);
      }, 1000);
      var bsocket;
      wHandle.friends = [];
      wHandle.myFriends = function () {
        return this.friends;
      };

      function bc() {
        null == sa &&
          ((sa = {}),
          wjQuery("#region").children().each(function () {
              var a = wjQuery(this),
                b = a.val();
              b && (sa[b] = a.text());
            }));

        $.get("/info", function (a) {
            var b = {},
              c;
            for (c in a.regions) {
              var n = c.split(":")[0];
              b[n] = b[n] || 0;
              b[n] += a.regions[c].numPlayers;
            }
            for (c in b)
              wjQuery('#region option[value="' + c + '"]').text( sa[c] + " (" + b[c] + " players)");
          },
          "json"
        );
      }

      function bubbleSetOnline(v) {
        if (bubbleRunning()) {
            v = Boolean(v);
            var msg = new DataView(new ArrayBuffer(2));
            msg.setUint8(0, 8);
            msg.setUint8(1, v);
            bubSend(msg);
        }
      }

      function gameLoop() {
        ma = true;
        bc();
        setInterval(bc, 18e4);
        document.getElementById("canvas").focus();
        var isTyping = false;
        var chattxt;
        mainCanvas = nCanvas = document.getElementById("canvas");
        ctx = mainCanvas.getContext("2d");

        mainCanvas.onmousemove = function (event) {
          rawMouseX = event.clientX;
          rawMouseY = event.clientY;
          mouseCoordinateChange();
        };

        if (touchable) {
          mainCanvas.addEventListener("touchstart", onTouchStart, false);
          mainCanvas.addEventListener("touchmove", onTouchMove, false);
          mainCanvas.addEventListener("touchend", onTouchEnd, false);
        }

        mainCanvas.onmouseup = function () {};
        if (/firefox/i.test(navigator.userAgent)) {
          document.addEventListener("DOMMouseScroll", handleWheel, false);
        } else {
          document.body.onmousewheel = handleWheel;
        }

        mainCanvas.onfocus = function () {
          isTyping = false;
        };

        const chatTextbox = document.getElementById("chat_textbox");
        if (chatTextbox) {
          chatTextbox.onblur = function () {
            isTyping = false;
          };

          chatTextbox.onfocus = function () {
            isTyping = true;
          };
        }

        var spacePressed = false,
          qPressed = false,
          ePressed = false,
          rPressed = false,
          tPressed = false,
          pPressed = false,
          wPressed = false;
          xdklas = false,
          yqweas = false,
          zxcasd = false;
        wHandle.onkeydown = function (event) {
          switch (event.keyCode) {
            case 13: // enter
              if (isTyping || !hideChat) {
                isTyping = false;
                document.getElementById("chat_textbox").blur();
                chattxt = document.getElementById("chat_textbox").value;
                if (chattxt.length > 0) sendChat(chattxt);
                document.getElementById("chat_textbox").value = "";
              } else {
                if (!hasOverlay) {
                  document.getElementById("chat_textbox").focus();
                  isTyping = true;
                }
              }
              break;
            case 17:
            if (!hasOverlay && !isTyping) {
							document.getElementById("chat_textbox").value = "/g ";
                            document.getElementById("chat_textbox").focus();
                            isTyping = true;
                        }
              break;
            case 32: 
              if (!spacePressed && !isTyping) {
                sendMouseMove();
                sendUint8(17);
                spacePressed = true;
              }
              break;
            case 87: 
              if (!wPressed && !isTyping) {
                sendMouseMove();
                sendUint8(21);
                wPressed = true;
              }
              break;
              case 65: 
      if (!xdklas && !isTyping) {
        sendUint8(26);
        xdklas = true;
      }
      break;
    case 83: 
      if (!yqweas && !isTyping) {
        sendUint8(27);
        yqweas = true;
      }
      break;
    case 68: 
      if (!zxcasd && !isTyping) {
        sendUint8(28);
        zxcasd = true;
      }
      break;
            case 81: // Q
              if (!qPressed && !isTyping) {
                sendUint8(18);
                qPressed = true;
              }
              break;
            case 69: // E
              if (!ePressed && !isTyping) {
                sendMouseMove();
                sendUint8(22);
              }
              break;
            case 82: // R
              if (!rPressed && !isTyping) {
                sendMouseMove();
                sendUint8(23);
                if (!rMacro) rPressed = true;
              }
              break;
            case 84: // T
              if (!tPressed && !isTyping) {
                sendMouseMove();
                sendUint8(24);
                tPressed = true;
              }
              break;
            case 80: // P
              if (!pPressed && !isTyping) {
                sendMouseMove();
                sendUint8(25);
                pPressed = true;
              }
              break;
            case 27: // esc
              showOverlays(true);
              break;
          }
        };
        wHandle.onkeyup = function (event) {
          switch (event.keyCode) {
            case 32: // space
              spacePressed = false;
              break;
            case 87: // W
              wPressed = false;
              break;
            case 81: // Q
              if (qPressed) {
                sendUint8(19);
                qPressed = false;
              }
              break;
                  case 65:
      xdklas = false;
      break;
    case 83:
      yqweas = false;
      break;
    case 68:
      zxcasd = false;
      break;
            case 69:
              ePressed = false;
              break;
            case 82:
              rPressed = false;
              break;
            case 84:
              tPressed = false;
              break;
            case 80:
              pPressed = false;
              break;
          }
        };
        wHandle.onblur = function () {
          sendUint8(19);
          wPressed =
            spacePressed =
            qPressed =
            ePressed =
            rPressed =
            tPressed =
            pPressed =
              false;
        };

        wHandle.onresize = canvasResize;
        canvasResize();
        if (wHandle.requestAnimationFrame) {
          wHandle.requestAnimationFrame(redrawGameScene);
        } else {
          setInterval(drawGameScene, 1e3 / 60);
        }
        setInterval(sendMouseMove, 40);

        null == ws && showConnecting();
        window.location.hash&&$a(location.pathname+location.search)
        wjQuery("#overlays").addClass("main-bg");
        wjQuery("#overlays").show();
            }

      function onTouchStart(e) {
        for (var i = 0; i < e.changedTouches.length; i++) {
          var touch = e.changedTouches[i];
          if (leftTouchID < 0 && touch.clientX < canvasWidth / 2) {
            leftTouchID = touch.identifier;
            leftTouchStartPos.reset(touch.clientX, touch.clientY);
            leftTouchPos.copyFrom(leftTouchStartPos);
            leftVector.reset(0, 0);
          }

          var size = ~~(canvasWidth / 7);
          if (
            touch.clientX > canvasWidth - size &&
            touch.clientY > canvasHeight - size
          ) {
            sendMouseMove();
            sendUint8(17); // split
          }

          if (
            touch.clientX > canvasWidth - size &&
            touch.clientY > canvasHeight - 2 * size - 10 &&
            touch.clientY < canvasHeight - size - 10
          ) {
            sendMouseMove();
            sendUint8(21); // eject
          }
        }
        touches = e.touches;
      }

      function formatSeconds(sec, ret) {
          sec = parseInt(sec);
          var time = "00:00";
          if (sec > 0) {
              var minutes = Math.floor(sec / 60);
              var seconds = sec - minutes * 60;
      
              if (minutes < 10) {
                  minutes = "0" + minutes;
              }
              if (seconds < 10) {
                  seconds = "0" + seconds;
              }
              time = minutes + ":" + seconds;
          }
          
          if (typeof ret !== "undefined") {
              return time;
          }
          
          if ([":9", ":7", ":5", ":2"].includes(currMode)) {
            wjQuery("#time2end").html(time);
          }
      }

      function onTouchMove(e) {
        e.preventDefault();
        for (var i = 0; i < e.changedTouches.length; i++) {
          var touch = e.changedTouches[i];
          if (leftTouchID == touch.identifier) {
            leftTouchPos.reset(touch.clientX, touch.clientY);
            leftVector.copyFrom(leftTouchPos);
            leftVector.minusEq(leftTouchStartPos);
            rawMouseX = leftVector.x * 3 + canvasWidth / 2;
            rawMouseY = leftVector.y * 3 + canvasHeight / 2;
            mouseCoordinateChange();
            sendMouseMove();
          }
        }
        touches = e.touches;
      }

      function onTouchEnd(e) {
        touches = e.touches;
        for (var i = 0; i < e.changedTouches.length; i++) {
          var touch = e.changedTouches[i];
          if (leftTouchID == touch.identifier) {
            leftTouchID = -1;
            leftVector.reset(0, 0);
            break;
          }
        }
      }

      function handleWheel(event) {
        if (!hasOverlay) {
          zoom *= Math.pow(0.9, event.wheelDelta / -120 || event.detail || 0);
        }

        // Limit zooming
      }

      function buildQTree() {
        if (0.4 > viewZoom) qTree = null;
        else {
          var a = Number.POSITIVE_INFINITY,
            b = Number.POSITIVE_INFINITY,
            c = Number.NEGATIVE_INFINITY,
            d = Number.NEGATIVE_INFINITY,
            e = 0;
          for (var i = 0; i < nodelist.length; i++) {
            var node = nodelist[i];
            if (
              node.shouldRender() &&
              !node.prepareData &&
              20 < node.size * viewZoom
            ) {
              e = Math.max(node.size, e);
              a = Math.min(node.x, a);
              b = Math.min(node.y, b);
              c = Math.max(node.x, c);
              d = Math.max(node.y, d);
            }
          }
          qTree = Quad.init({
            minX: a - (e + 100),
            minY: b - (e + 100),
            maxX: c + (e + 100),
            maxY: d + (e + 100),
            maxChildren: 2,
            maxDepth: 4,
          });
          for (i = 0; i < nodelist.length; i++) {
            node = nodelist[i];
            if (node.shouldRender() && !(20 >= node.size * viewZoom)) {
              for (a = 0; a < node.points.length; ++a) {
                b = node.points[a].x;
                c = node.points[a].y;
                b < nodeX - canvasWidth / 2 / viewZoom ||
                  c < nodeY - canvasHeight / 2 / viewZoom ||
                  b > nodeX + canvasWidth / 2 / viewZoom ||
                  c > nodeY + canvasHeight / 2 / viewZoom ||
                  qTree.insert(node.points[a]);
              }
            }
          }
        }
      }

      function mouseCoordinateChange() {
        X = (rawMouseX - canvasWidth / 2) / viewZoom + nodeX;
        Y = (rawMouseY - canvasHeight / 2) / viewZoom + nodeY;
      }

      function hideOverlays() {
        hasOverlay = false;
        wjQuery("#overlays").css("background", "");
        wjQuery("#overlays").css("background-color", "rgba(0, 0, 0, 0.498039)");
        wjQuery("#overlays").hide();
        wjQuery("#stats").hide();
      }

      function showOverlays(arg) {
        userNickName = null;
        if (arg) {
          if (event && event.keyCode === 27) {
            hasOverlay = true;
            wjQuery("#overlays")
              .css("background", "rgba(0, 0, 0, 0.5)")
              .fadeIn(200);
          } else {
            wjQuery("#overlays")
              .css("background", "rgba(0, 0, 0, 0.5)")
              .fadeIn(200, function () {
                hasOverlay = true;
              });
          }
        } else {
          wjQuery("#overlays")
            .css(
              "background",
              "url(assets/img/background.png) 0px 0px no-repeat scroll rgba(0, 0, 0, 0)"
            )
            .fadeIn(3e3, function () {
              hasOverlay = true;
            });
        }
      }
      function bConnect(a) {
        if (bsocket) {
          bsocket.onopen = null;
          bsocket.onmessage = null;
          bsocket.onclose = null;
          try {
            bsocket.close();
          } catch (c) {}
          bsocket = null;
        }
        bsocket = new WebSocket(a);
        bsocket.binaryType = "arraybuffer";
        bsocket.onopen = function () {
          wjQuery("#battle-spect").prop("disabled", false);
          var hash = "493e175a-71ca-41df-94fc-ab5d9bf634ad";
          bubbleLogin(hash);
        };

        bsocket.onclose = function () {
          bubLogged = false;
          wjQuery(".showFriends").prop("disabled", true);
          ftabledefault(false);
          wjQuery(".modal").modal("hide");
          var random = Math.floor(Math.random() * (20 - 4 + 1)) + 4;

          console.log("WS closed. Trying to reconnect in " + random + " seconds..");
          setTimeout(function () {
            bConnect(a);
          }, random * 1000);
        };
        bsocket.onmessage = bubbleMessage;
        bsocket.onerror = function () {
          console.log("WebSocket error");
          setTimeout(function () {
            bConnect(a);
          }, 1000);
        };
      }
      function gIcon(on) {
        if(on) {
            return '<i class="fa fa-gamepad"></i>';
        } else {
            return '<div class="online"></div>';
        }
      }

      function ftabledefault(battle) {
        if (!battle) wjQuery("#friends-view-modal-data h2").show();
        if (!battle) wjQuery("#friends-view-modal-data table").html("");
        if (!battle) wjQuery("#tournament-modal .tournament-invite").html("");
        if (battle) wjQuery("#tournament-modal .tournament-players").html("");
      }
      function displayFriends(friends, battle, leader) {
        function tableFriends(friends, battle) {
          ftabledefault(battle);
          if (friends.length > 0) {
            if (!battle) {
              wjQuery("#friends-view-modal-data h2").hide();
              wjQuery("#friends-view-modal-data table tbody").empty();
              if (friends.length === 0) {
                wjQuery("#friends-view-modal-data h2").show();
                return;
              }
            } else {
              wjQuery(".tournament-players").empty();
            }
            
            for (var i = 0; i < friends.length; i++) {
              var c = JSON.parse(friends[i].c);
              if (battle) {
                var appendTr =
                  '<tr><td style="text-align:left;width: 15%;">' +
                  '<span class="img-circle friends-circle"style="background-color:rgba(' +
                  c.r +
                  "," +
                  c.g +
                  "," +
                  c.b +
                  ',0.7);">' +
                  friends[i].n.substr(0, 1).toUpperCase() +
                  "</span></td>" +
                  '<td style="width:65%">' +
                  friends[i].n +
                  "</td>";
      
                var ds1 = friends[i].r;
                if (ds1.length > 0) {
                  ds1 = ds1.split("=");
                  var pe12 =
                    (parseInt(ds1[0]) / (parseInt(ds1[0]) + parseInt(ds1[1]))) *
                    100;
                  if (pe12 > 40 && parseInt(ds1[0]) > 5) {
                    ds1 =
                      '<span style="color:' +
                      (pe12 > 50 ? "green" : "orange") +
                      ';">' +
                      parseInt(pe12) +
                      "%</span>";
                  } else {
                    ds1 = "";
                  }
                }
                appendTr += "<td>" + ds1 + "</td>";
                if (player_id == leader && friends[i].id != leader) {
                  appendTr +=
                    '<td style="text-align:right;cursor:pointer;" class="text-muted">' +
                    '<i class="fa fa-ban" aria-hidden="true" onClick="bKick(' +
                    friends[i].id +
                    '); $(this).remove();"></i></td>';
                } else appendTr += "<td></td>";
                {
                  appendTr += "</tr>";
                }
                wjQuery(".tournament-players").append(appendTr);
              } else {
                var ff = friends.filter((f, idx, arr) => arr.findIndex(x => x.u === f.u) === idx);if (ff.findIndex(f => f.u === friends[i].u) !== i) continue;
                var appendTr = `<tr class="inviteplayer_${+friends[i]
                  .i}" data-player="${
                  friends[i].u
                }" style="border-bottom: 1px solid #eee">
      
              <td style="text-align: left; width: 15%; border-top: none; position: relative">
                  <span class="img-circle friends-circle" style="background-color:rgba(${
                    c.r
                  },${c.g},${c.b},0.7)">
                      ${friends[i].n[0].toUpperCase()}
                  </span>
              </td>
              <td style="width: 65%; border-top:none;padding-top: 10px;">
                  <span style="display:inline-block">${friends[i].n}</span>
              </td>
              <td style="width: 10%; text-align:center;border-top:none;padding-top:10px">
                  ${friends[i].p}
              </td>
             <td style="width: 10%; text-align:center;border-top:none;padding-top:10px;" class="d-online">
              ${friends[i].s > 0 ? 'Battle' : gIcon(friends[i].o)}
            </td>
            </tr>`;
                wjQuery("#friends-view-modal-data table").append(appendTr);
                wjQuery("#tournament-modal .tournament-invite").append(appendTr);
              }
            }
          }
        }
        tableFriends(friends, battle);
      }
      function bubbleMessage(msg) {
        if (typeof msg.data === "string") {
          var drb = JSON.parse(msg.data);
          if (typeof drb.friends != "undefined") {
            displayFriends(drb.friends, false);
          } else if (drb.ffs) {
            var pis = wjQuery(`.inviteplayer_${drb.ffs.i}`);
            if (pis.length > 0) {
              if (typeof drb.ffs.offline != "undefined") {
                pis.remove();
                if (wjQuery("#friends-view-modal-data table tr").length == 0) {
                  wjQuery("#friends-view-modal-data h2").show();
                }
              }
              if (typeof drb.ffs.online !== "undefined") {
                  pis.children(".d-online").html(gIcon(drb.ffs.online));
                }
              if(typeof drb.ffs.server !== "undefined") {
                 if (drb.ffs.server > 0) {
                   const dOnline = pis.children(".d-online");
                   dOnline.html("2v2");
                   pis.prop("disabled", true).addClass("tr-disabled");
                 } else {
                   pis.children(".d-online").html(gIcon(false));
                   pis.prop("disabled", false).removeClass("tr-disabled");
                }
              }
            }
            if (typeof drb.ffs.new !== "undefined") {
              if (
                wjQuery(`.inviteplayer_${drb.ffs.new.i}`).length > 0 &&
                drb.ffs.new.o
              )
                return;

              if (wjQuery(`[data-player="${drb.ffs.new.u}"]`).length > 0) return;

              wjQuery("#friends-view-modal-data h2").hide();
              const c = JSON.parse(drb.ffs.new.c);
              const tr = `<tr class="inviteplayer_${+drb.ffs.new
                .i}" data-player="${
                drb.ffs.new.u
              }" style="border-bottom: 1px solid #eee">
                <td style="text-align: left; width: 15%; border-top: none; position: relative;">
                    <span class="img-circle friends-circle" style="background-color:rgba(${
                      c.r
                    },${c.g},${c.b},0.7);">
                        ${drb.ffs.new.n[0].toUpperCase()}
                    </span>
                </td>
                <td style="width: 65%; border-top: none; padding-top: 10px;" data-player="${
                  drb.ffs.new.u
                }">
                  <span style="display: inline-block">${drb.ffs.new.n}</span>
                </td>
                <td style="width: 10%; text-align: center; border-top: none; padding-top: 10px;">
                    ${drb.ffs.new.p}
                </td>
                <td style="width: 10%; text-align: center; border-top: none; padding-top: 10px;" class="d-online">
            ${drb.ffs.new.s > 0 ? '2v2' : gIcon(drb.ffs.new.o)}
        </td>
              </tr>`;
              wjQuery(
                "#friends-view-modal-data table, #tournament-modal .tournament-invite"
              ).append(tr);
            }
          } else if (drb.leader) {
            switch (drb.status) {
              case 0:
                wjQuery(".battle-srvstatus").html("Waiting for start");
                break;
              case 1:
                wjQuery(".battle-srvstatus").html("Finding a game");
                break;
              case 2:
                wjQuery(".battle-srvstatus").html("Preparing");
                break;
              case 3:
                wjQuery(".battle-srvstatus").html("Starting!");
                break;
            }

            if (drb.status == 3 && sent2battle == false && (drb.ip + currentMode() == srvInfo())) {
              if (lastUserAct() > 5) playsound("connected.mp3");
              setNick(document.getElementById("nick").value);
              wjQuery(".modal").modal("hide");
              sent2battle = true;
            } else if (drb.status !== 3) {
              if (drb.status == 2 && battlec == false) {
                wsConnect("wss://" + drb.ip, drb.port);
                battlec = true;
              }
              if (drb.status !== 2) battlec = false;
              sent2battle = false;
              if (!wjQuery("#tournament-modal").hasClass("in")) {
                wjQuery("#tournament-modal").modal({
                  keyboard: false,
                  backdrop: "static",
                });
              }

              if (player_id == drb.leader) {
                wjQuery("#button-start-battle, #i8DN").show();
                if (!wjQuery("#button-start-battle").hasClass("active"))
                  wjQuery("#button-start-battle").prop("disabled", false);
              } else {
                wjQuery("#button-start-battle").hide();
              }

              if (drb.online < drb.max) {
                wjQuery("#button-start-battle")
                  .prop("disabled", true)
                  .removeClass("active");
                wjQuery(".tournament-invite")
                  .find("tr")
                  .prop("disabled", false)
                  .css("opacity", 1);
              } else {
                wjQuery(".tournament-invite")
                  .find("tr")
                  .prop("disabled", true)
                  .css("opacity", 0.3);
              }

              wjQuery("#tournament-modal").attr("data-battleid", "" + drb.id + "");
              wjQuery('.battle-mode').text(getModeName(drb.mode,1));
              wjQuery(".battle-online").html(drb.online + "/" + drb.max);

              if (drb.mode === 11) {
                if (player_id == drb.leader && drb.f == true) {
                  wjQuery("#i8DN").show();
                } else wjQuery("#i8DN").hide();
                wjQuery(".battle-reward").text("1.5 pt.");
                wjQuery(".battle-defeated").text("0.7 pt. ");
                wjQuery("#battleNotify").hide();
                wjQuery("#battleNotify11").show();
              } else {
                wjQuery(".battle-reward").text("rank * 0.5 pt.");
                wjQuery(".battle-defeated").text("rank *  0.25 pt. ");
                wjQuery("#battleNotify").show();
                wjQuery("#battleNotify11").hide();
                wjQuery("#i8DN").hide();
              }

              displayFriends(drb.players, true, drb.leader);
            }
          } else if (drb.chat && drb.chat.length > 0) {
            wjQuery("#tournament-modal table.chat-table").html("");
            for (var i = 0; i < drb.chat.length; i++) {
              var c = JSON.parse(drb.chat[i].c);
              wjQuery("#tournament-modal table.chat-table").append(
                '<tr><td style="word-break: break-all;"><strong style="color:rgb(' +
                  c.r +
                  "," +
                  c.g +
                  "," +
                  c.b +
                  ');">' +
                  drb.chat[i].u +
                  "</strong>: " +
                  htmlspecialchars(drb.chat[i].m) +
                  "</td></tr>"
              );
            }
          }
          var chatContainer = wjQuery("#tournament-modal .bub-box-scroll");
            chatContainer.scrollTop(chatContainer[0].scrollHeight);
        } else {
          readPacket(new DataView(msg.data));
        }
      }
      function htmlspecialchars(html) {
        html = html.replace(/&/g, "&amp;");
        html = html.replace(/</g, "&lt;");
        html = html.replace(/>/g, "&gt;");
        html = html.replace(/"/g, "&quot;");
        return html;
      }
      function readPacket(view) {
        function getString() {
          var text = "",
            char;
          while ((char = view.getUint16(offset, true)) != 0) {
            offset += 2;
            text += String.fromCharCode(char);
          }
          offset += 2;
          return text;
        }

        var offset = 0;
        if (240 == view.getUint8(offset)) {
          offset += 5;
        }

        switch (view.getUint8(offset++)) {
      case 1:
        const status = view.getUint8(offset++);
        bubLogged = status;
        if (bubLogged == 1) {
          player_id = view.getUint32(offset, true);
          bubParm(0, wjQuery("#check_Notify").is(":checked") ? 1 : 0);
          bubParm(2, wjQuery("#check_Notify11").is(":checked") ? 1 : 0);
          wjQuery(".showFriends").prop("disabled", false);
        } else if (bubLogged == 2) {
          ws.close();
          bsocket.close();
        }
        break;
          case 98:
            manageNotifi(view, offset);
            break;
          case 99:
            if (lastUserAct() > 10) alert_audio.play();
            bubbleChat(view, offset);
            break;
        }
      }
      function manageNotifi(view, offset) {
        function getString() {
          var text = "",
            char;
          while ((char = view.getUint16(offset, true)) != 0) {
            offset += 2;
            text += String.fromCharCode(char);
          }
          offset += 2;
          return text;
        }

        noti_s = view.getUint8(offset++);

        let text = "";

        if (offset + 1 < view.byteLength) {
          text = getString();
        }

        switch (noti_s) {
          case 0:
            updateNotifications(noti_s, "Player is offline.", "error");
            break;
          case 1:
            updateNotifications(
              noti_s,
              "Invitation has been successfully sent.",
              "success"
            );
            break;
          case 2:
            updateNotifications(noti_s, text + "  has logged in.", "success");
            break;
          case 3:
            updateNotifications(
              noti_s,
              text + " has rejected the invitation.",
              "error"
            );
            break;
          case 4:
            updateNotifications(noti_s, "Player is not available.", "error");
            break;
          case 5:
            updateNotifications(noti_s, "battle_error", "error");
            break;
          case 6:
            alert("Battle mode is not available. Please try again later.");
            wjQuery("#playBtn").removeClass("active").prop("disabled", false);
            break;
          case 7:
            wjQuery("#tournament-modal").modal("toggle");
            alert(
              "You need at least 5 points to play 1 vs 1 battle. If defeated you lose 0.5 pt."
            );
            break;
          case 8:
            updateLiveBattles(text);
            break;
          case 9:
            updateNotifications(
              noti_s,
              "Player with the same 1v1 rank is waiting for the opponent.",
              "warning",
              10001
            );
            break;
          case 11:
            updateNotifications(
              noti_s,
              "Invitation has been successfully sent. (" + text + " players)",
              "success"
            );
            break;
          case 12:
            updateNotifications(
              noti_s,
              text + " invited you to play 2 vs 2.",
              "warning",
              20000
            );
            break;
          case 230:
            var msg = dtview(1);
            msg.setUint8(0, 230);
            bubSend(msg);
            break;
        }

        if (noti_s == 0 || noti_s == 1 || noti_s == 3) {
          wjQuery(".inviteplayer_" + text)
            .prop("disabled", true)
            .addClass("tr-disabled");
          setTimeout(function () {
            wjQuery(".inviteplayer_" + text)
              .prop("disabled", false)
              .removeClass("tr-disabled");
          }, 10000);
        }
      }

      function updateLiveBattles(t1) {
        function nrbi(r3) {
          var r4 = "",
              si1 = "height:30px;width:40px;";
          r3 = parseInt(r3);
          if (r3 >= 10) {
            r4 = '<img style="' + si1 + '" src="assets/img/rank_' + r3 + '.png?v2">';
          } else {
            r4 = '<div style="' + si1 + 'opacity:0;"></div>';
          }
          return r4;
        }

        t1 = JSON.parse(t1);
        //t1.reverse();
        text3 = '<table class="table table-striped table-hover"><tbody>';
        for (f1 in t1) {
          var points = [];
          var team = { 0: ["", -1], 1: ["", -1] };
          var battleStarted = (Date.now() - t1[f1]["c"]) / 1000 + 30;
          for (g1 in t1[f1]["in"]) {
            points.push(t1[f1]["in"][g1]["p"]);
            var n2 = t1[f1]["in"][g1]["n"];
            if (typeof n2 == "object") {
              for (x1 in n2) {
                var n3 = n2[x1].split(":");
                team[g1][0] += n3[0] + ", ";
                if (n3[1] > team[g1][1]) team[g1][1] = n3[1];
              }
              team[g1][0] = team[g1][0].substring(0, team[g1][0].length - 2);
            } else {
              var n3 = n2.split(":");
              team[g1][0] += n3[0];
              team[g1][1] = n3[1];
            }
            //team[g1] = (typeof n2 == 'object' ? n2.join('<br />') : n2);
          }
          text3 +=
            '<tr class="connect" data-srv="' + t1[f1]["i"] +
            '-11-0-1" style="cursor:pointer;">' +
            '<td class="bli-b">' +
            nrbi(team[0][1]) +
            "</td>" +
            '<td class="fb-lo2g">' +
            team[0][0] +
            "</td>" +
            '<td class="pb-lo2g"><strong style="font-size:17px;">' +
            points.join(":") +
            "</strong><br />" +
            '<span style="color:silver;font-size:11px;">' +
            formatSeconds(battleStarted, 1) +
            "</span></td>" +
            '<td class="sb-lo2g">' +
            team[1][0] +
            "</td>" +
            '<td class="bli-b">' +
            nrbi(team[1][1]) +
            "</td></tr>";
        }
        text3 += "</tbody></table>";
        wjQuery("#battle-live-data").html(text3);
      }

      function bubbleChat(view, offset) {
        function getString() {
          var text = "",
            char;
          while ((char = view.getUint16(offset, true)) != 0) {
            offset += 2;
            text += String.fromCharCode(char);
          }
          offset += 2;
          return text;
        }

        var flags = view.getUint8(offset++);

        var r = view.getUint8(offset++),
          g = view.getUint8(offset++),
          b = view.getUint8(offset++);

        const name = getString();
        const message = getString();

        notiBoard.push({
          name: name,
          color: "rgb(" + r + "," + g + "," + b + ")",
          message: message,
          time: Date.now(),
        });
        DrawChatBoard();
      }

      function DrawChatBoard() {
       var len = notiBoard.length;

		var chatnick = notiBoard[len - 1].name;
		var state;
		var dsfdsf = Date.now();
		var notiMessage = notiBoard[len - 1].message;
		if(notiMessage.length > 10) {
			 var id_split    = notiMessage.split(':');
			if(id_split.length == 4) {
				wjQuery("#bubbleNotifications").append('<div id="mess_'+dsfdsf+'" class="bubble_invite warning"><i onClick="cInvite('+id_split[2]+
        ', false);" class="fa fa-times" style="color: #7D4D03; font-size: 16px; "></i> <span data-srv="'+id_split[0]+'-'+id_split[1]+'-'+id_split[2]+'-'+id_split[3]+'" class="invite-accept"><strong>'+
          chatnick+'</strong> invited you to play '+getModeName(id_split[1])+'. <a href="#"><i class="fa fa-play-circle"></i></a></span></div>');
				wjQuery("#mess_"+dsfdsf).delay(15000).fadeOut(0);

				if (wjQuery('#bubbleNotifications div').length > 15) { wjQuery('#bubbleNotifications div').eq(0).remove(); }
			}
		}
	}

      function updateNotifications(s1, info,type, expireT) {
	      	if (typeof expireT == 'undefined') {
	      		var expireT = 3000;
	      	}
	      	var fadeOut1 = 0;
	      	var d1 = Date.now();
	      	var icon = 'check-circle-o';
	      	var style1 = '';
	      	switch(type) {
	      		case 'warning': icon = 'exclamation-triangle'; break;
	      		case 'error':   icon = 'exclamation-circle'; break;
	      	}
      
	      	if(info == 'battle_error') {
	      		info = 'Battle is no longer active.';
	      		if(wjQuery('#tournament-modal').hasClass('in')) {
	      			wjQuery('#tournament-modal').modal('toggle');
	      		} 
	      	}
	      	var onCl1 = '';
	      	var in1 = '<i class="fa fa-'+icon+'"></i>';
	      	
	      	if(s1 == 9) {
	      		onCl1 = 'onClick="setGameMode(\':11\', 1); createBattleServer(12);"';
	      	}		
	      	
          if(s1 == 12) {
    var id_split = info.split(':');
    var ds1 = id_split[3];
    if(ds1.length > 0) {
        ds1 = ds1.split('=');
        ds1 = '<span style="color:green;">'+ds1[0]+'</span>:<span style="color:red;">'+ds1[1]+'</span>';
    }
    in1 = '<i onClick="cInvite('+id_split[2]+',false);" class="fa fa-times" style="color: #7D4D03; font-size: 16px; "></i>';
    info = '<span data-srv="tournament-2vs2-'+id_split[2]+'-'+id_split[1]+'-11" class="invite-accept"><strong>'+id_split[0]+'</strong> '+id_split[4]+' '+ds1+'</span>';
}
	      	if(s1 == 13) {
	      		wjQuery('#mess_top1time').remove();
	      		wjQuery('body').append('<div id="mess_top1time" style="color: #54c154;position: absolute;left:40%;font: 35px Ubuntu;">Top Time++ '+formatSeconds(info/60,1)+'</div>');
	      		wjQuery("#mess_top1time").fadeOut(3000);
	      	} else {
	      		var notiDiv = '<div id="mess_'+d1+'" class="bubble_invite '+type+'" '+onCl1+' '+style1+'> '+in1+' '+info+'</div>';
	      		wjQuery("#bubbleNotifications").append(notiDiv);
	      		wjQuery("#mess_"+d1).delay(expireT).fadeOut(fadeOut1);
	      	}
		if (wjQuery('#bubbleNotifications div').length > 15) { wjQuery('#bubbleNotifications div').eq(0).remove(); }
	}
      function bubbleRunning() {
        return null != bsocket && bsocket.readyState == bsocket.OPEN;
      }
      function bubSend(a) {
        bsocket.send(a.buffer);
      }

      function bubParm(a, b) {
        if (bubbleRunning()) {
          var msg = new DataView(new ArrayBuffer(3));
          b = parseInt(b);
          msg.setUint8(0, 9);
          msg.setUint8(1, a);
          msg.setUint8(2, b);
          bubSend(msg);
        }
      }

      function bubbleLogin(hash) {
        if (bubbleRunning()) {
          const bufferSize = 1 + 4 + hash.length;
          const msg = new DataView(new ArrayBuffer(bufferSize));

          msg.setUint8(0, 1);

          msg.setUint32(1, hash.length, true);

          for (let i = 0; i < hash.length; i++) {
            msg.setUint8(5 + i, hash.charCodeAt(i));
          }

          bubSend(msg);
        }
      };

      function srvLogin(login) {
        const bufferSize = 1 + 4 + login.length;
        const msg = new DataView(new ArrayBuffer(bufferSize));
        msg.setUint8(0, 2);
        msg.setUint32(1, login.length, true);

        for (let i = 0; i < login.length; i++) {
          msg.setUint8(5 + i, login.charCodeAt(i));
        }

        wsSend(msg);
      };


      function setCookieConfig(name, value) {
        const d = new Date();
        d.setTime(d.getTime() + 30 * 24 * 60 * 60 * 1000);
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
      }

      window.createBattleServer = function (mode) {
        if (bubbleRunning()) {
          wjQuery("#playBtn").toggleClass("active").prop("disabled", 1);
          wjQuery("#tournament-modal table.chat-table").html("");

          var msg = new DataView(new ArrayBuffer(7));
          msg.setUint8(0, 4);
          msg.setUint8(1, parseInt(mode));
          msg.setUint8(2, 1);
          bubSend(msg);
        } else {
          alert("Battle mode is not available. Please try again later.");
          wjQuery("#playBtn").prop("disabled", false);
        }
      };
      window.liveBattles = function (value) {
        if (bubbleRunning()) {
          var msg = new DataView(new ArrayBuffer(2));
          msg.setUint8(0, 98);
          msg.setUint8(1, value);
          bubSend(msg);
        }
      };

      window.bKick = function (playerId) {
        const lobbyId = wjQuery("#tournament-modal").attr("data-battleid");

        if (bubbleRunning() && lobbyId) {
          const msg = new DataView(new ArrayBuffer(1 + 1 + 4 + lobbyId.length + 4));

          msg.setUint8(0, 5);
          msg.setUint8(1, 1);
          msg.setUint32(2, lobbyId.length, true);

          for (let i = 0; i < lobbyId.length; i++) {
            msg.setUint8(6 + i, lobbyId.charCodeAt(i));
          }

          msg.setUint32(6 + lobbyId.length, playerId, true);

          bubSend(msg);
        }
      };
      window.cInvite = function (inviterId, accepted) {
        if (bubbleRunning()) {
          var msg = new DataView(new ArrayBuffer(7));
          msg.setUint8(0, 3);
          msg.setUint8(1, 2);
          msg.setUint32(2, inviterId, true);
          msg.setUint8(6, accepted ? 1 : 0);
          bubSend(msg);
        }
      };
      window.bInvA = function (bID) {
        if (bubbleRunning()) {
          const msg = new DataView(new ArrayBuffer(2 + 4 + bID.length));
          msg.setUint8(0, 11);
          msg.setUint8(1, 1);
          msg.setUint32(2, bID.length, true);

          for (let i = 0; i < bID.length; i++) {
            msg.setUint8(6 + i, bID.charCodeAt(i));
          }
          bubSend(msg);
        }
      };
      window.bClose = function () {
        const lobbyId = wjQuery("#tournament-modal").attr("data-battleid");

        if (lobbyId && bubbleRunning()) {
          const msg = new DataView(new ArrayBuffer(1 + 1 + 4 + lobbyId.length));
          msg.setUint8(0, 2);
          msg.setUint8(1, 1);
          msg.setUint32(2, lobbyId.length, true);
          for (let i = 0; i < lobbyId.length; i++) {
            msg.setUint8(6 + i, lobbyId.charCodeAt(i));
          }


          wjQuery("#playBtn").toggleClass("active").prop("disabled", false);

          bubSend(msg);
        }
      };

      window.skinChange = function (skinType) {
        if (bubbleRunning() && bubLogged) {
          const msg = new DataView(new ArrayBuffer(3 + skinType.length));
          msg.setUint8(0, 125);
          msg.setUint8(1, skinType.length);
          for (let i = 0; i < skinType.length; i++) {
            msg.setUint8(2 + i, skinType.charCodeAt(i));
          }
          wsSend(msg);
        }
      };
      window.bChat = function (message) {
        const lobbyId = wjQuery("#tournament-modal").attr("data-battleid");
        if ((bubbleRunning() && message.length > 0) || message.length < 100) {
          const totalSize = 6 + message.length + lobbyId.length;
          const msg = new DataView(new ArrayBuffer(totalSize));

          msg.setUint8(0, 6);
          msg.setUint32(1, message.length, true);
          msg.setUint8(5, lobbyId.length);

          for (let i = 0; i < lobbyId.length; i++) {
            msg.setUint8(6 + i, lobbyId.charCodeAt(i));
          }

          const messageOffset = 6 + lobbyId.length;
          for (let i = 0; i < message.length; i++) {
            msg.setUint8(messageOffset + i, message.charCodeAt(i));
          }

          bubSend(msg);
        }
      };
      window.bStart = function (lobbyId) {
        if (!lobbyId) {
          console.error("Brak ID lobby");
          return;
        }
        const buffer = new ArrayBuffer(6 + lobbyId.length);
        const view = new DataView(buffer);

        view.setUint8(0, 7);
        view.setUint32(1, lobbyId.length, true);
        view.setUint8(5, lobbyId.length);

        for (let i = 0; i < lobbyId.length; i++) {
          view.setUint8(6 + i, lobbyId.charCodeAt(i));
        }

        bubSend(view);
      };

      function showConnecting() {
        if (ma) {
          wjQuery("#connecting").show();
          wsConnect((useHttps ? "wss://" : "ws://") + CONNECTION_URL);
        }
      }

      function L() {
        if (Ia == 0 && y) {
          mb();
        }
      }
      setInterval(function () {
        0 == Ia && y && L();
      }, 1000);

      function mb() {
        $("#connecting").show();
        $("#time2end").html("");
        Ia++;

        $.ajax("/m", {
            error: function() {
                setTimeout(mb, 1000);
            },
            success: function(a) {
                a = a.split("\n");
                wsConnect("wss://" + a[0], a[1]);

                var kmsd = btoa(a[0] + a[1]);

                if (parseInt(V.substr(1)) < 10) {
                    $("#friendsZone").val(window.location.origin+'/x'+kmsd);
                    $("#fDza").show();
                } else {
                    $("#fDza").hide();
                }
            },
            dataType: "text",
            method: "POST",
            cache: 0,
            crossDomain: 1,
            data: "dm=" + y + V
        });
      }

      function wsConnect(wsUrl, port, goSpec) {
        if (ws) {
          console.log("[wsConnect] Zamykanie poprzedniego poczenia");
          ws.onopen = null;
          ws.onmessage = null;
          ws.onclose = null;
          try {
            ws.close();
          } catch (b) {}
          ws = null;
        }

        bz = [];
        cp = [];
        nodes = {};
        nodelist = [];
        Cells = [];
        leaderBoard = [];
        mainCanvas = teamScores = null;
        userScore = 0;
        currSrv = wsUrl;
        $("#playBtn").prop("disabled", 1);

        if (wsUrl.length < 10) {
          $("#playBtn").prop("disabled", false);
          return;
        }

        ws = new WebSocket(wsUrl);
        ws.binaryType = "arraybuffer";
        ws.onopen = function () {
          onWsOpen();
          var userHash = "493e175a-71ca-41df-94fc-ab5d9bf634ad";
          srvLogin(userHash);
          $("#playBtn").prop("disabled", 0);
          if (goSpec) {
            spectate();
          }
        };
        ws.onmessage = onWsMessage;
        ws.onclose = onWsClose;
      }
      function prepareData(a) {
        return new DataView(new ArrayBuffer(a));
      }

      function wsSend(a) {
        ws.send(a.buffer);
      }
      function httpGet(theUrl) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", theUrl, false); // false for synchronous request
        xmlHttp.send(null);
        return xmlHttp.responseText;
      }

      function onWsOpen() {
        var msg;
        delay = 500;
        wjQuery("#connecting").hide();
        msg = prepareData(5);
        msg.setUint8(0, 254);
        msg.setUint32(1, 5, true); // Protocol 5
        wsSend(msg);
        msg = prepareData(5);
        msg.setUint8(0, 255);
        msg.setUint32(1, 0, true);
        wsSend(msg);
        log.info("Connection successful!");

      }

      function onWsClose() {
        setTimeout(showConnecting, delay);
        delay *= 1.5;
      }

      function onWsMessage(msg) {
        handleWsMessage(new DataView(msg.data));
      }

      function handleWsMessage(msg) {
        function getString() {
          var text = "",
            char;
          while ((char = msg.getUint16(offset, true)) != 0) {
            offset += 2;
            text += String.fromCharCode(char);
          }
          offset += 2;
          return text;
        }

        var offset = 0,
          setCustomLB = false;
        240 == msg.getUint8(offset) && (offset += 5);
        switch (msg.getUint8(offset++)) {
          case 16: // update nodes
            updateNodes(msg, offset);
            break;
          case 17: // update position
            posX = msg.getFloat32(offset, true);
            offset += 4;
            posY = msg.getFloat32(offset, true);
            offset += 4;
            posSize = msg.getFloat32(offset, true);
            offset += 4;
            break;
          case 20: // clear nodes
            cp = [];
            bz = [];
            break;
          case 21: // draw line
            lineX = msg.getInt16(offset, true);
            offset += 2;
            lineY = msg.getInt16(offset, true);
            offset += 2;
            if (!drawLine) {
              drawLine = true;
              drawLineX = lineX;
              drawLineY = lineY;
            }
            break;
          case 32: // add node
            bz.push(msg.getUint32(offset, true));
            offset += 4;
            break;
          case 48:
            noRanking = true;
            teamScores = null;
            var LBplayerNum = msg.getUint32(offset, true);
            offset += 4;
            leaderBoard = [];
            for (i = 0; i < LBplayerNum; ++i) {
              var nodeId = msg.getUint32(offset, true);
              offset += 4;
              leaderBoard.push({
                id: nodeId,
                name: getString(),
              });
            }
            drawLeaderBoard();
            break;
          case 49: // update leaderboard (ffa)
            if (!setCustomLB) {
              noRanking = false;
            }
            teamScores = null;
            var LBplayerNum = msg.getUint32(offset, true);
            offset += 4;
            leaderBoard = [];
            for (i = 0; i < LBplayerNum; ++i) {
              var nodeId = msg.getUint32(offset, true);
              offset += 4;
              leaderBoard.push({
                id: nodeId,
                name: getString(),
              });
            }
            drawLeaderBoard();
            break;
          case 50: // update leaderboard (teams)
            teamScores = [];
            var LBteamNum = msg.getUint32(offset, true);
            offset += 4;
            for (var i = 0; i < LBteamNum; ++i) {
              teamScores.push(msg.getFloat32(offset, true));
              offset += 4;
            }
            drawLeaderBoard();
            break;
          case 64: // set border
            leftPos = msg.getFloat64(offset, true);
            offset += 8;
            topPos = msg.getFloat64(offset, true);
            offset += 8;
            rightPos = msg.getFloat64(offset, true);
            offset += 8;
            bottomPos = msg.getFloat64(offset, true);
            offset += 8;

            if (!spectate) {
              posX = (rightPos + leftPos) / 2;
              posY = (bottomPos + topPos) / 2;
              posSize = 1;

              if (0 == cp.length) {
                nodeX = posX;
                nodeY = posY;
                viewZoom = posSize;
              }
            }
            break;
            case 89:
            var nStatus = msg.getUint8(offset++);
            var nText = '', char;
        
            while ((char = msg.getUint16(offset, true)) != 0) {
                nText += String.fromCharCode(char);
                offset += 2;
            }
				
				    switch(nStatus) {
				    	case 0: spectate(); setTimeout(hideOverlay,100); break;
				    	case 1: bStartConf(); break;
				    	case 2: stchkilog(true); break;
				    	case 3: shwdebug(nText); break;
				    	case 4: alert(nText); break;
              case 13: updateNotifications(nStatus, nText); break;
				    	case 230: var a = P(1);a.setUint8(0, 230);Q(a); break;
				    }
    
				    break;
            case 90:
				    dat = msg.getFloat64(offset, true);
				    offset += 8;
				    formatSeconds(dat);
				    break;
            case 99:
            addChat(msg, offset);
            break;
        }
      }

      function csl(e, id) {
          const s = wjQuery(e).find('span[style*="nfx"]');
          if (s.length === 0) return;
          
          function mk() {
            const n = Math.floor(Math.random() * 3) + 2;
            const d = [];
            
            for (let i = 0; i < n; i++) {
              const t = wjQuery('<div class="ppx"></div>');
              const x = Math.random() * 100;
              const y = Math.random() * 100;
              const p = { left: x + '%', top: y + '%' };
              const col = s.css('color');
              const rx = (Math.random() - 0.5) * 4 + 'px';
              const ry = (Math.random() - 0.5) * 4 + 'px';
              
              t.css(p).css('--random-x', rx).css('--random-y', ry)
               .css('background', `linear-gradient(to bottom, transparent, ${col}, transparent)`)
               .css('box-shadow', `0 0 5px ${col}, 0 0 10px ${col}`);
              
              s.append(t);
              d.push(t);
            }
            
            setTimeout(() => d.forEach(t => t.remove()), 600);
          }
          
          const iv = setInterval(() => {
            if (wjQuery(e).length === 0 || s.length === 0) {
              clearInterval(iv);
              return;
            }
            mk();
          }, 250);
          
          setTimeout(() => clearInterval(iv), 30000);
        }

      function addChat(view, offset) {
        offset = 1; 
        var state2 = view.getUint8(offset++);
        var r = view.getUint8(offset++);
        var g = view.getUint8(offset++);
        var b = view.getUint8(offset++);
        var color = ((r << 16) | (g << 8) | b).toString(16);
        while (color.length < 6) color = "0" + color;
        color = "#" + color;
      
        function getString() {
          var text = "", char;
          while ((char = view.getUint16(offset, true)) !== 0) {
            offset += 2;
            text += String.fromCharCode(char);
          }
          offset += 2;
          return text;
        }
      
        var senderName = getString();
        var message = getString();
      
        chatBoard.push({
          name: senderName,
          color: senderName === "System" ? "#FF0000" : color,
          message: message,
          time: Date.now(),
          state2: state2
        });

      
        drawChatBoard();
      }


      function drawChatBoard() {
        if (chatBoard.length === 0) return;

        var len = chatBoard.length;
        var lastMessage = chatBoard[len - 1];

        if (lastMessage.displayed) return;
        lastMessage.displayed = true;

        if (showDarkTheme) {
          wjQuery("#chatLog").css("color", "white");
          wjQuery("#chat_textbox")
            .css("color", "white")
            .css("background", "rgba(255, 255, 255, 0.2) none repeat scroll 0 0");
        } else {
          wjQuery("#chatLog").css("color", "black");
          wjQuery("#chat_textbox")
            .css("color", "black")
            .css("background", "rgba(0, 0, 0, 0.2) none repeat scroll 0 0");
        }

        var chatClassID = Date.now();
        var chatNick = lastMessage.name;
        var chatMessage = lastMessage.message;
        dop = 0;

        var state2 = lastMessage.state2 || 0;
        if (chatNick == "[system]") {
          chatNick = "";
          if (chatMessage.indexOf("|") > -1) {
            chatMessage = chatMessage.split("|");
            state2 = `3" style="color: ${color};`;
            chatMessage = chatMessage[0];
          } else {
            state2 = 3;
          }
        } else {
          chatNick =
            '<strong style="color:' +
            lastMessage.color +
            '">' +
            chatNick +
            "</strong> ";
        }

        wjQuery("#chatLog").append(
          '<div class="mess_' +
            chatClassID +
            " mess_type_" +
            state2 +
            '">' +
            chatNick +
            chatMessage +
            "</div>"
        );

        if (state2 === 5) {
          var messageElement = wjQuery(".mess_" + chatClassID)[0];
          csl(messageElement, chatClassID);
        }

        wjQuery(".mess_" + chatClassID)
          .delay(30000)
          .fadeOut(500);

        if (wjQuery("#chatLog div").length > 20) {
          wjQuery("#chatLog div").eq(0).remove();
        }

        var chatWindow = document.getElementById("chatLog");
        dif = chatWindow.scrollHeight - chatWindow.scrollTop - dop;

        if (dif < 530) {
          wjQuery("#chatLog").scrollTop(500000);
        }
      }

      function updateNodes(view, offset) {
        timestamp = +new Date();
        var code = Math.random();
        ua = false;
        uo = view.getUint8(offset++);
        fo = view.getUint8(offset++);
        ub = view.getUint8(offset++);

        var queueLength = view.getUint16(offset, true);
        offset += 2;

        for (i = 0; i < queueLength; ++i) {
          var killer = nodes[view.getUint32(offset, true)],
            killedNode = nodes[view.getUint32(offset + 4, true)];
          offset += 8;
          if (killer && killedNode) {
            killedNode.destroy();
            killedNode.ox = killedNode.x;
            killedNode.oy = killedNode.y;
            killedNode.oSize = killedNode.size;
            killedNode.nx = killer.x;
            killedNode.ny = killer.y;
            killedNode.nSize = killedNode.size;
            killedNode.updateTime = timestamp;
            Tb(killer, killedNode);
          }
        }

        for (var i = 0; ; ) {
          var nodeid = view.getUint32(offset, true);
          offset += 4;
          if (0 == nodeid) break;
          ++i;

          var size,
            posY,
            posX = view.getInt32(offset, true);
          offset += 4;
          posY = view.getInt32(offset, true);
          offset += 4;
          size = view.getInt16(offset, true);
          offset += 2;

          var gid = view.getUint32(offset, true);
          offset += 4;

          for (
            var r = view.getUint8(offset++),
              g = view.getUint8(offset++),
              b = view.getUint8(offset++),
              color = ((r << 16) | (g << 8) | b).toString(16);
            6 > color.length;

          )
            color = "0" + color;
          var colorstr = "#" + color,
            flags = view.getUint8(offset++),
            flagVirus = !!(flags & 0x01),
            flagEjected = !!(flags & 0x20),
            flagAgitated = !!(flags & 0x10),
            _skin = "";

          flags & 2 && (offset += 4);

          if (flags & 4) {
            for (;;) {
              // skin name
              t = view.getUint8(offset, true) & 0x7f;
              offset += 1;
              if (0 == t) break;
              _skin += String.fromCharCode(t);
            }
          }

          for (var char, name = ""; ; ) {
            // nick name
            char = view.getUint16(offset, true);
            offset += 2;
            if (0 == char) break;
            name += String.fromCharCode(char);
          }

          var node = null;
          if (nodes.hasOwnProperty(nodeid)) {
            node = nodes[nodeid];
            node.updatePos();
            node.ox = node.x;
            node.oy = node.y;
            node.oSize = node.size;
            node.color = colorstr;
          } else {
            node = new Cell(nodeid, posX, posY, size, colorstr, name, _skin, gid);
            nodelist.push(node);
            nodes[nodeid] = node;
            node.ka = posX;
            node.la = posY;
          }
          node.isVirus = flagVirus;
          node.isEjected = flagEjected;
          node.isAgitated = flagAgitated;
          node.nx = posX;
          node.ny = posY;
          node.setSize(size);
          node.updateCode = code;
          node.updateTime = timestamp;
          node.flag = flags;
          name && node.setName(name);
          if (
      -1 != bz.indexOf(nodeid) &&
      -1 == cp.indexOf(node)
      ) {
      cp.push(node);
      if (1 == cp.length) {
        nodeX = node.x;
        nodeY = node.y;
        sb = Date.now(),
        Qa = 0,
        S = Ta = Ua = 0,
        O = 0,
        Sa = true,
        x = [],
        Ra = cp[0].color
      }
      }
        }
        queueLength = view.getUint32(offset, true);
        offset += 4;
        for (i = 0; i < queueLength; i++) {
          var nodeId = view.getUint32(offset, true);
          offset += 4;
          node = nodes[nodeId];
          null != node && node.destroy();
        }
        if (!hasOverlay && ((ua && cp.length === 0 && uo && !fo) || fo)) {
         tb = Date.now();
         $("#overlays").removeClass("main-bg").fadeIn(1000, function() {
           hasOverlay = true; 
         });
         ub ? (
           Vb(),
           $("#stats").show(),
           $("#formStd").hide(),
           quey()
         ) : (
           $("#formStd").show(),
           $("#stats").hide()
         );
       }
      }

      function quey() {
        if(logged == 1) {
            bubbleSetOnline(false);
            wjQuery('#escapingLEVEL > div.clearfix').hide();
            wjQuery('#escapingBallG').show();

            setTimeout(function(){
                wjQuery.ajax({
                    url: '/query',
                    method: "POST",
                    data: { 'do': 1 },
                    xhrFields: {
                        withCredentials: true
                    }
                }).done(function( msg ) {
                    wjQuery('.progress-bar-striped').css('width', msg.perc);
                    wjQuery('.progress-bar-star').text(msg.lvl);
                    wjQuery('.progress-bar-text').text(msg.text);

                    wjQuery('#escapingBallG').hide();
                    wjQuery('#escapingLEVEL > div.clearfix').fadeIn(500);
                });
            }, 6000);
        }
      }

      function sendMouseMove() {
        var msg;
        if (wsIsOpen()) {
          msg = rawMouseX - canvasWidth / 2;
          var b = rawMouseY - canvasHeight / 2;
          if (
            64 <= msg * msg + b * b &&
            !(0.01 > Math.abs(oldX - X) && 0.01 > Math.abs(oldY - Y))
          ) {
            oldX = X;
            oldY = Y;
            msg = prepareData(21);
            msg.setUint8(0, 16);
            msg.setFloat64(1, X, true);
            msg.setFloat64(9, Y, true);
            msg.setUint32(17, 0, true);
            wsSend(msg);
          }
        }
      }

      function sendNickName() {
        if (wsIsOpen() && null != userNickName) {
          var msg = prepareData(1 + 2 * userNickName.length);
          msg.setUint8(0, 0);
          for (var i = 0; i < userNickName.length; ++i)
            msg.setUint16(1 + 2 * i, userNickName.charCodeAt(i), true);
          wsSend(msg);
        }
      }

      function sendChat(str) {
        if (wsIsOpen() && str.length < 200 && str.length > 0 && hideChat) {
          if (str == "/fix") {
            wHandle.spectate();
          } else {
            var msg = prepareData(2 + 2 * str.length);
            var offset = 0;
            msg.setUint8(offset++, 99);
            msg.setUint8(offset++, 0); // flags (0 for now)
            for (var i = 0; i < str.length; ++i) {
              msg.setUint16(offset, str.charCodeAt(i), true);
              offset += 2;
            }

            wsSend(msg);
          }
        }
      }

      function wsIsOpen() {
        return null != ws && ws.readyState == ws.OPEN;
      }

      function sendUint8(a) {
        if (wsIsOpen()) {
          var msg = prepareData(1);
          msg.setUint8(0, a);
          wsSend(msg);
        }
      }

      function redrawGameScene() {
        drawGameScene();
        wHandle.requestAnimationFrame(redrawGameScene);
      }

      function canvasResize() {
        window.scrollTo(0, 0);
        canvasWidth = wHandle.innerWidth;
        canvasHeight = wHandle.innerHeight;
        nCanvas.width = canvasWidth;
        nCanvas.height = canvasHeight;
        drawGameScene();
      }

      function viewRange() {
        var ratio;
        ratio = Math.max(canvasHeight / 1080, canvasWidth / 1920);
        return ratio * zoom;
      }

      function calcViewZoom() {
        if (0 != cp.length) {
          for (var newViewZoom = 0, i = 0; i < cp.length; i++)
            newViewZoom += cp[i].size;
          newViewZoom = Math.pow(Math.min(64 / newViewZoom, 1), 0.4) * viewRange();
          viewZoom = (9 * viewZoom + newViewZoom) / 10;
        }
      }


      function drawGameScene() {
        if (hasOverlay == false) {
          var a, oldtime = Date.now();
          ++cb;
          timestamp = oldtime;
          if (0 < cp.length) {
            calcViewZoom();
            var c = (a = 0);
            for (var d = 0; d < cp.length; d++) {
              cp[d].updatePos();
              a += cp[d].x / cp.length;
              c += cp[d].y / cp.length;
            }
            posX = a;
            posY = c;
            posSize = viewZoom;
            nodeX = (nodeX + a) / 2;
            nodeY = (nodeY + c) / 2;
          } else {
            nodeX = (29 * nodeX + posX) / 30;
            nodeY = (29 * nodeY + posY) / 30;
            viewZoom = (9 * viewZoom + posSize * viewRange()) / 10;
          }
          buildQTree();
          mouseCoordinateChange();
          xa || ctx.clearRect(0, 0, canvasWidth, canvasHeight);
          if (xa) {
            if (showDarkTheme) {
              ctx.fillStyle = "#111111";
              ctx.globalAlpha = 0.05;
              ctx.fillRect(0, 0, canvasWidth, canvasHeight);
              ctx.globalAlpha = 1;
            } else {
              ctx.fillStyle = "#F2FBFF";
              ctx.globalAlpha = 0.05;
              ctx.fillRect(0, 0, canvasWidth, canvasHeight);
              ctx.globalAlpha = 1;
            }
          } else {
            drawGrid();
          }
          nodelist.sort(function (a, b) {
            return a.size === b.size ? a.id - b.id : a.size - b.size;
          });
          ctx.save();
          ctx.translate(canvasWidth / 2, canvasHeight / 2);
          ctx.scale(viewZoom, viewZoom);
          ctx.translate(-nodeX, -nodeY);
          if (showBorder) {
            ctx.beginPath();
            ctx.strokeStyle = showDarkTheme ? "white" : "#666666";
            ctx.lineWidth = 2;
            ctx.moveTo(leftPos, topPos);
            ctx.lineTo(rightPos, topPos);
            ctx.lineTo(rightPos, bottomPos);
            ctx.lineTo(leftPos, bottomPos);
            ctx.lineTo(leftPos, topPos);
            ctx.stroke();
          }
          for (d = 0; d < Cells.length; d++) Cells[d].drawOneCell(ctx);
          for (d = 0; d < nodelist.length; d++) nodelist[d].drawOneCell(ctx);
          if (drawLine) {
            drawLineX = (3 * drawLineX + lineX) / 4;
            drawLineY = (3 * drawLineY + lineY) / 4;
            ctx.save();
            ctx.strokeStyle = "#FFAAAA";
            ctx.lineWidth = 10;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            for (d = 0; d < cp.length; d++) {
              ctx.moveTo(cp[d].x, cp[d].y);
              ctx.lineTo(drawLineX, drawLineY);
            }
            ctx.stroke();
            ctx.restore();
          }
          ctx.restore();

          if (lbCanvas && lbCanvas.width) {
            ctx.drawImage(lbCanvas, canvasWidth - lbCanvas.width - 10, 10);
          }
          if (chatCanvas != null) {
            ctx.drawImage(chatCanvas, 0, canvasHeight - chatCanvas.height - 50);
          }

          userScore = Math.max(userScore, calcUserScore());
          if (0 != userScore) {
            if (null == scoreText) {
              scoreText = new UText(24, "#FFFFFF");
            }
            scoreText.setValue("Score: " + ~~(userScore / 100));
            c = scoreText.render();
            a = c.width;
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = "#000000";
            ctx.fillRect(10, 10, a + 10, 34);
            ctx.globalAlpha = 1;
            ctx.drawImage(c, 15, 15);
          }
          drawSplitIcon(ctx);
          drawTouch(ctx);

          var deltatime = Date.now() - oldtime;
          if (deltatime > 1000 / 60) {
            z -= 0.01;
          } else if (deltatime < 1000 / 65) {
            z += 0.01;
          }
          if (z < 0.4) z = 0.4;
          if (z > 1) z = 1;
          
          var timeDiff = timestamp - lastUpdate;
          if (!wsIsOpen()) {
            s += timeDiff / 2000;
            if (s > 1) s = 1;
          } else {
            s -= timeDiff / 300;
            if (s < 0) s = 0;
          }
          if (s > 0) {
            ctx.fillStyle = "#000000";
            ctx.globalAlpha = 0.5 * s;
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            ctx.globalAlpha = 1;
          }
          lastUpdate = timestamp;
        }
      }

      function $a(a) {
            wHandle.history && wHandle.history.replaceState && wHandle.history.replaceState({}, wHandle.document.title
                , a)
        }

      function drawTouch(ctx) {
        ctx.save();
        if (touchable) {
          for (var i = 0; i < touches.length; i++) {
            var touch = touches[i];
            if (touch.identifier == leftTouchID) {
              ctx.beginPath();
              ctx.strokeStyle = "#0096ff";
              ctx.lineWidth = 6;
              ctx.arc(
                leftTouchStartPos.x,
                leftTouchStartPos.y,
                40,
                0,
                Math.PI * 2,
                true
              );
              ctx.stroke();
              ctx.beginPath();
              ctx.strokeStyle = "#0096ff";
              ctx.lineWidth = 2;
              ctx.arc(
                leftTouchStartPos.x,
                leftTouchStartPos.y,
                60,
                0,
                Math.PI * 2,
                true
              );
              ctx.stroke();
              ctx.beginPath();
              ctx.strokeStyle = "#0096ff";
              ctx.arc(leftTouchPos.x, leftTouchPos.y, 40, 0, Math.PI * 2, true);
              ctx.stroke();
            } else {
              ctx.beginPath();
              ctx.beginPath();
              ctx.strokeStyle = "#0096ff";
              ctx.lineWidth = "6";
              ctx.arc(touch.clientX, touch.clientY, 40, 0, Math.PI * 2, true);
              ctx.stroke();
            }
          }
        }
        ctx.restore();
      }

      function drawGrid() {
        ctx.fillStyle = showDarkTheme ? "#111111" : "#F2FBFF";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        if (noGrid) return;
        ctx.save();
        ctx.strokeStyle = showDarkTheme ? "#AAAAAA" : "#000000";
        ctx.globalAlpha = 0.2;
        ctx.scale(viewZoom, viewZoom);
        var a = canvasWidth / viewZoom,
          b = canvasHeight / viewZoom;
        for (var c = -0.5 + ((-nodeX + a / 2) % 50); c < a; c += 50) {
          ctx.moveTo(c, 0);
          ctx.lineTo(c, b);
        }
        ctx.stroke();
        ctx.beginPath();
        for (c = -0.5 + ((-nodeY + b / 2) % 50); c < b; c += 50) {
          ctx.moveTo(0, c);
          ctx.lineTo(a, c);
        }
        ctx.stroke();
        ctx.restore();
      }

      function drawSplitIcon(ctx) {
        if (isTouchStart && splitIcon.width) {
          var size = ~~(canvasWidth / 7);
          ctx.drawImage(
            splitIcon,
            canvasWidth - size,
            canvasHeight - size,
            size,
            size
          );
        }

        if (isTouchStart && splitIcon.width) {
          var size = ~~(canvasWidth / 7);
          ctx.drawImage(
            ejectIcon,
            canvasWidth - size,
            canvasHeight - 2 * size - 10,
            size,
            size
          );
        }
      }

      function calcUserScore() {
        for (var score = 0, i = 0; i < cp.length; i++)
          score += cp[i].nSize * cp[i].nSize;
        return score;
      }

      function drawLeaderBoard() {
        lbCanvas = null;
        var drawTeam = null != teamScores;
        if (drawTeam || 0 != leaderBoard.length) {
          lbCanvas = document.createElement("canvas");
          var ctx = lbCanvas.getContext("2d"),
            boardLength = 60;
          boardLength = !drawTeam
            ? boardLength + 24 * leaderBoard.length
            : boardLength + 180;
          var scaleFactor =
            Math.min(0.22 * canvasHeight, Math.min(200, 0.3 * canvasWidth)) *
            0.005;
          lbCanvas.width = 200 * scaleFactor;
          lbCanvas.height = boardLength * scaleFactor;
      
          ctx.scale(scaleFactor, scaleFactor);
          ctx.globalAlpha = 0.4;
          ctx.fillStyle = "#000000";
          ctx.fillRect(0, 0, 200, boardLength);
      
          ctx.globalAlpha = 1;
          ctx.fillStyle = "#FFFFFF";
          var c = "Leaderboard";
          ctx.font = "30px Ubuntu";
          ctx.fillText(c, 100 - ctx.measureText(c).width * 0.5, 40);
          var b, l;
      
          if (leaderBoard[0] && leaderBoard[0].name === "Game starting in") {
            var t = parseInt(
              leaderBoard[1] ? leaderBoard[1].name || leaderBoard[1] : 0
            );
            var mt = currMode.includes("10") ? 6 : 4;
            if (!isNaN(t) && t !== lT && t < mt && t > 0) {
              lT = t;
              photography_audio.pause();
              photography_audio.ct = 0;
              photography_audio.play();
            }
          } else lT = null;
          if (!drawTeam) {
            for (ctx.font = "20px Ubuntu", b = 0, l = leaderBoard.length; b < l; ++b) {
              c = leaderBoard[b].name || "An unnamed cell";
              // if (!showName) c = "An unnamed cell";
      
              var me = -1 != bz.indexOf(leaderBoard[b].id);
              if (me && cp[0] && cp[0].name) {
                c = cp[0].name;
              }
      
              me ? (ctx.fillStyle = "#FFAAAA") : (ctx.fillStyle = "#FFFFFF");
              if (!noRanking) c = b + 1 + ". " + c;
      
              var start = ctx.measureText(c).width > 200 ? 2 : 100 - ctx.measureText(c).width * 0.5;
              ctx.fillText(c, start, 70 + 24 * b);
            }
          } else {
            for (b = c = 0; b < teamScores.length; ++b) {
              var d = c + teamScores[b] * Math.PI * 2;
              ctx.fillStyle = teamColor[b + 1];
              ctx.beginPath();
              ctx.moveTo(100, 140);
              ctx.arc(100, 140, 80, c, d, false);
              ctx.fill();
              c = d;
            }
          }
        }
      }
      function Cell(uid, ux, uy, usize, ucolor, uname, a, g) {
        this.id = uid;
        this.gid = g;
        this.ox = this.x = ux;
        this.oy = this.y = uy;
        this.oSize = this.size = usize;
        this.color = ucolor;
        this.points = [];
        this.pointsAcc = [];
        this.createPoints();
        this.setName(uname);
        this._skin = a;
      }

      function UText(usize, ucolor, ustroke, ustrokecolor) {
        usize && (this._size = usize);
        ucolor && (this._color = ucolor);
        this._stroke = !!ustroke;
        ustrokecolor && (this._strokeColor = ustrokecolor);
      }
      function Tb(a, b) {
        var c = -1 != cp.indexOf(a);
        var n = cp[0]?.name || "";
        var o = b.name === n;

        if (c && !o && !b.isVirus && !b.isEjected) {
            if (b.name) {
                ++Ta;
            } else {
                ++Qa;
            }
        }
      }
      function cc() {
        if (null == leaderBoard) return 0;
        for (var a = 0; a < leaderBoard.length; ++a) {
            for (var i = 0; i < cp.length; i++) {
                if (cp[i].id === leaderBoard[a].id) {
                    return a + 1;
                }
            }
        }
        return 0;
      }

      function Eb(a) {
            a = ~~a;
        var b = (a % 60).toString();
        a = (~~(a / 60)).toString();
        2 > b.length && (b = "0" + b);
        return a + ":" + b;
      }
      function Vb() {
            wjQuery(".stats-food-eaten").text(Qa);
            wjQuery(".stats-time-alive").text(Eb((tb - sb) / 1E3));
            wjQuery(".stats-leaderboard-time").text(Eb(Ua));
            wjQuery(".stats-highest-mass").text(~~(userScore / 100));
            wjQuery(".stats-cells-eaten").text(Ta);
            wjQuery(".stats-top-position").text(0 == S ? ":(" : S);

        var a = document.getElementById("statsGraph");
        if (a) {
            var b = a.getContext("2d"),
                c = a.width,
                a = a.height;
            b.clearRect(0, 0, c, a);
            if (2 < x.length) {
                for (var d = 200, p = 0; p < x.length; p++) d = Math.max(x[p], d);
                b.lineWidth = 3;
                b.lineCap = "round";
                b.lineJoin = "round";
                b.strokeStyle = Ra;
                b.fillStyle = Ra;
                b.beginPath();
                b.moveTo(0, a - x[0] / d * (a - 10) + 10);
                for (p = 1; p < x.length; p += Math.max(~~(x.length / c), 1)) {
                    for (var f = p / (x.length - 1) * c, g = [], k = -20; 20 >= k; ++k)
                        0 > p + k || p + k >= x.length || g.push(x[p + k]);
                    g = g.reduce(function(a, b) {
                        return a + b
                    }) / g.length / d;
                    b.lineTo(f, a - g * (a - 10) + 10);
                }
                b.stroke();
                b.globalAlpha = 0.5;
                b.lineTo(c, a);
                b.lineTo(0, a);
                b.fill();
                b.globalAlpha = 1;
            }
        }
      }

      var localProtocol = wHandle.location.protocol,
        localProtocolHttps = "https:" == localProtocol;
      var nCanvas,
        ctx,
        mainCanvas,
        lbCanvas,
        chatCanvas,
        canvasWidth,
        canvasHeight,
        qTree = null,
        ws = null,
        currSrv = "",
        currMode = ":5",
        V = "5",
        Ia = 0,
        Fa = true,
        y = "eu",
        nodeX = 0,
        nodeY = 0,
        bz = [],
        cp = [],
        nodes = {},
        nodelist = [],
        Cells = [],
        leaderBoard = [],
        chatBoard = [],
        rawMouseX = 0,
        rawMouseY = 0,
        X = -1,
        Y = -1,
        cb = 0,
        timestamp = 0,
        userNickName = null,
        leftPos = 0,
        topPos = 0,
        rightPos = 1e4,
        bottomPos = 1e4,
        viewZoom = 1,
        showSkin = true,
        showName = true,
        showColor = false,
        noGrid = false,
        ua = false,
        uo = true,
        fo = false,
        ub = true,
        userScore = 0,
        showDarkTheme = false,
        showMass = false,
        showOthersMass = false,
        hideChat = false,
        smoothRender = 0.4,
        posX = (nodeX = ~~((leftPos + rightPos) / 2)),
        posY = (nodeY = ~~((topPos + bottomPos) / 2)),
        posSize = 1,
        teamScores = null,
        ma = false,
        hasOverlay = true,
        showBorder = false,
        drawLine = false,
        lineX = 0,
        lineY = 0,
        drawLineX = 0,
        drawLineY = 0,
        Ra = 0,
        teamColor = ["#333333", "#FF3333", "#33FF33", "#3333FF"],
        xa = false,
        zoom = 1,
        isTouchStart =
          "ontouchstart" in wHandle &&
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          ),
        splitIcon = new Image(),
        ejectIcon = new Image(),
        noRanking = false;
      splitIcon.src = "assets/img/split.png";
      ejectIcon.src = "assets/img/feed.png";
      var wCanvas = document.createElement("canvas");
      var playerStat = null;
      var sa = null;
      wHandle.isSpectating = false;
      wHandle.setNick = function (arg) {
        bubbleSetOnline(true);
        hideOverlays();
        userNickName = arg;
        sendNickName();
        userScore = 0;
      };
      window.currentMode = function () {
        return currMode;
      };

      window.srvInfo = function () {
        currSrv = currSrv.replace("wss://", "");
        return currSrv + currMode;
      };

      window.setGameMode = function (a) {
        currMode = a.substr(0, 3);
        gameMode = a;
      
        if (a != V) {
          V = a;
          Ia = 0;
          L();
        }
      
        if (a.substr(0, 3) == ":11" || a.substr(0, 3) == ":12") {
          sessionStorage.setItem("mode", ":11");
        } else {
          sessionStorage.setItem("mode", a);
        }
      
        wjQuery(".friends-online").hide();
      };
      window.getModeName = function getModeName(id, chk) {
        var srvname = "";
        if (typeof chk == "undefined" && id.substr(0, 1) == ":") id = id.substr(1);
        id = parseInt(id);
        switch (id) {
          case 0:
            srvname = "FFA - 1x";
            break;
          case 1:
            srvname = "Teams";
            break;
          case 2:
            srvname = "Experimental";
            break;
          case 3:
            srvname = "Teams HC";
            break;
          case 5:
            srvname = "FFA - 5x";
            break;
          case 7:
            srvname = "FFA - hardcore";
            break;
          case 8:
            srvname = "FFA - no teams";
            break;
          case 9:
            srvname = "Clan Wars";
            break;
          case 10:
            srvname = "Tournament";
            break;
          case 11:
            srvname = "2 vs 2";
            break;
          case 12:
            srvname = "1 vs 1";
            break;
          case 13:
            srvname = "Test Server";
            break;
          default:
            srvname = "n/a";
        }
        return srvname;
      };
      wHandle.setSkins = function (arg) {
        setCookieConfig("ShowSkin", arg ? 1 : 0);
        showSkin = arg;
        if (!arg) skins = {};
      };
      wHandle.setNames = function (arg) {
        setCookieConfig("ShowName", arg ? 1 : 0);
        showName = arg;
      };
      wHandle.setDarkTheme = function (arg) {
        setCookieConfig("DarkTheme", arg ? 1 : 0);
        showDarkTheme = arg;
      };
      wHandle.setColors = function (arg) {
        setCookieConfig("ShowColor", arg ? 1 : 0);
        showColor = arg;
      };
      wHandle.setShowBorder = function (arg) {
        setCookieConfig("ShowBorder", arg ? 1 : 0);
        showBorder = arg;
      };
      wHandle.setNoGrid = function (arg) {
        setCookieConfig("NoGrid", arg ? 1 : 0);
        noGrid = arg;
      };
      wHandle.setShowMass = function (arg) {
        setCookieConfig("ShowMass", arg ? 1 : 0);
        showMass = arg;
      };
      wHandle.setShowOthersMass = function (arg) {
        setCookieConfig("ShowOthersMass", arg ? 1 : 0);
        showOthersMass = arg;
      };
      wHandle.setSmooth = function (arg) {
        smoothRender = arg ? 2 : 0.4;
      };
      wHandle.displayChat = function (arg) {
        setCookieConfig("Chat", arg ? 1 : 0);
        hideChat = arg;
        if(arg) {
          wjQuery("#enableChat").css('display','inline');
        } else {
          wjQuery("#enableChat").css('display','none');
        }
      };
      wHandle.spectate = function () {
          userNickName = null;
          wHandle.isSpectating = true;
          sendUint8(1);
        hideOverlays();
      };
      wHandle.setAcid = function (arg) {
        xa = arg;
      };
      window.battleNotify = function (a, b) {
        setCookieConfig(b == 12 ? "Notify" : "Notify11", a ? 1 : 0);
        bubParm(b == 12 ? 0 : 2, a ? 1 : 0);
      };
      wHandle.openSkinsList = function (arg) {
        if ($("#inPageModalTitle").text() != "Skins") {
          $.get("include/gallery.php").then(function (data) {
            $("#inPageModalTitle").text("Skins");
            $("#inPageModalBody").html(data);
          });
        }
      };
      if (wHandle.localStorage != null) {
         wjQuery(window).load(function () {
           wjQuery("#check_Notify").prop("checked", /(^|;) ?Notify=1(;|$)/.test(document.cookie));
           wjQuery("#check_Notify11").prop("checked", /(^|;) ?Notify11=1(;|$)/.test(document.cookie));
       
           wjQuery(".save").each(function () {
             const id = $(this).data("box-id");
             const name = "checkbox-" + id;
             const value = document.cookie.match(new RegExp("(^|;) ?" + name + "=([^;]*)(;|$)"));
             const val = value ? value[2] : null;
             const isChecked = val === "true" || (val === null && id === 5);
       
             if (id === 0) {
               if (val !== null) $(this).val(val);
               return;
             }
       
             $(this).prop("checked", isChecked);
             if (id === 5) wHandle.displayChat(isChecked);
             if (isChecked) $(this).trigger("change");
           });
       
           wjQuery(".save").change(function () {
             const id = $(this).data("box-id");
             const value = id === 0 ? $(this).val() : $(this).prop("checked");
             setCookieConfig("checkbox-" + id, value);
           });
         });
       }
      setTimeout(function () {}, 3e5);
      var T = {
        ZW: "EU-London",
      };
      wHandle.connect = wsConnect;

      var data = {
        action: "test",
      };
      fetch("skinList.txt")
        .then((resp) => resp.text())
        .then((data) => {
          const skins = data.split(",").filter((name) => name.length > 0);
          for (var i = 0; i < skins.length; i++) {
            if (-1 == knownNameDict.indexOf(skins[i])) {
              knownNameDict.push(skins[i]);
            }
          }
        });

      var delay = 500,
        oldX = -1,
        oldY = -1,
        Canvas = null,
        z = 1,
        scoreText = null,
        skins = {},
        knownNameDict = "".split(";"),
        knownNameDict_noDisp = [],
        ib = ["_canvas'blob"];
      Cell.prototype = {
        id: 0,
        points: null,
        pointsAcc: null,
        name: null,
        nameCache: null,
        sizeCache: null,
        x: 0,
        y: 0,
        size: 0,
        ox: 0,
        oy: 0,
        oSize: 0,
        nx: 0,
        ny: 0,
        nSize: 0,
        flag: 0,
        updateTime: 0,
        updateCode: 0,
        drawTime: 0,
        destroyed: false,
        isVirus: false,
        isEjected: false,
        isAgitated: false,
        wasSimpleDrawing: true,
        destroy: function () {
          var tmp;
          for (tmp = 0, len = nodelist.length; tmp < len; tmp++)
            if (nodelist[tmp] === this) {
              nodelist.splice(tmp, 1);
              break;
            }
          delete nodes[this.id];
          tmp = cp.indexOf(this);
          if (-1 != tmp) {
            ua = true;
            cp.splice(tmp, 1);
          }
          tmp = bz.indexOf(this.id);
          if (-1 != tmp) bz.splice(tmp, 1);
          this.destroyed = true;
          Cells.push(this);
        },
        getNameSize: function () {
          return Math.max(~~(0.3 * this.size), 24);
        },
        setName: function (a) {
          this.name = a;
          if (null == this.nameCache) {
            this.nameCache = new UText(
              this.getNameSize(),
              "#FFFFFF",
              true,
              "#000000"
            );
            this.nameCache.setValue(this.name);
          } else {
            this.nameCache.setSize(this.getNameSize());
            this.nameCache.setValue(this.name);
          }
        },
        setSize: function (a) {
          this.nSize = a;
          var m = ~~(this.size * this.size * 0.01);
          if (null === this.sizeCache)
            this.sizeCache = new UText(
              this.getNameSize() * 0.5,
              "#FFFFFF",
              true,
              "#000000"
            );
          else this.sizeCache.setSize(this.getNameSize() * 0.5);
        },
        createPoints: function () {
          for (
            var samplenum = this.getNumPoints();
            this.points.length > samplenum;

          ) {
            var rand = ~~(Math.random() * this.points.length);
            this.points.splice(rand, 1);
            this.pointsAcc.splice(rand, 1);
          }
          if (0 == this.points.length && 0 < samplenum) {
            this.points.push({
              ref: this,
              size: this.size,
              x: this.x,
              y: this.y,
            });
            this.pointsAcc.push(Math.random() - 0.5);
          }
          while (this.points.length < samplenum) {
            var rand2 = ~~(Math.random() * this.points.length),
              point = this.points[rand2];
            this.points.splice(rand2, 0, {
              ref: this,
              size: point.size,
              x: point.x,
              y: point.y,
            });
            this.pointsAcc.splice(rand2, 0, this.pointsAcc[rand2]);
          }
        },
        getNumPoints: function () {
          if (0 == this.id) return 16;
          var a = 10;
          if (20 > this.size) a = 0;
          if (this.isVirus) a = 30;
          var b = this.size;
          if (!this.isVirus) b *= viewZoom;
          b *= z;
          if (this.flag & 32) b *= 0.25;
          return ~~Math.max(b, a);
        },
        movePoints: function () {
          this.createPoints();
          for (
            var points = this.points,
              pointsacc = this.pointsAcc,
              numpoints = points.length,
              i = 0;
            i < numpoints;
            ++i
          ) {
            var pos1 = pointsacc[(i - 1 + numpoints) % numpoints],
              pos2 = pointsacc[(i + 1) % numpoints];
            pointsacc[i] += (Math.random() - 0.5) * (this.isAgitated ? 3 : 1);
            pointsacc[i] *= 0.7;
            10 < pointsacc[i] && (pointsacc[i] = 10);
            -10 > pointsacc[i] && (pointsacc[i] = -10);
            pointsacc[i] = (pos1 + pos2 + 8 * pointsacc[i]) / 10;
          }
          for (
            var ref = this,
              isvirus = this.isVirus
                ? 0
                : (this.id / 1e3 + timestamp / 1e4) % (2 * Math.PI),
              j = 0;
            j < numpoints;
            ++j
          ) {
            var f = points[j].size,
              e = points[(j - 1 + numpoints) % numpoints].size,
              m = points[(j + 1) % numpoints].size;
            if (
              12 < this.size &&
              null != qTree &&
              20 < this.size * viewZoom &&
              0 != this.id
            ) {
              var l = false,
                n = points[j].x,
                q = points[j].y;
              qTree.retrieve2(n - 5, q - 5, 10, 10, function (a) {
                if (
                  a.ref != ref &&
                  25 > (n - a.x) * (n - a.x) + (q - a.y) * (q - a.y)
                ) {
                  l = true;
                }
              });
              if (
                (!l && points[j].x < leftPos) ||
                points[j].y < topPos ||
                points[j].x > rightPos ||
                points[j].y > bottomPos
              ) {
                l = true;
              }
              if (l) {
                if (0 < pointsacc[j]) {
                  pointsacc[j] = 0;
                }
                pointsacc[j] -= 1;
              }
            }
            f += pointsacc[j];
            0 > f && (f = 0);
            f = this.isAgitated
              ? (19 * f + this.size) / 20
              : (12 * f + this.size) / 13;
            points[j].size = (e + m + 8 * f) / 10;
            e = (2 * Math.PI) / numpoints;
            m = this.points[j].size;
            this.isVirus && 0 == j % 2 && (m += 5);
            points[j].x = this.x + Math.cos(e * j + isvirus) * m;
            points[j].y = this.y + Math.sin(e * j + isvirus) * m;
          }
        },
        updatePos: function () {
          if (0 == this.id) return 1;
          var a;
          a = (timestamp - this.updateTime) / 120;
          a = 0 > a ? 0 : 1 < a ? 1 : a;
          var b = 0 > a ? 0 : 1 < a ? 1 : a;
          this.getNameSize();
          if (this.destroyed && 1 <= b) {
            var c = Cells.indexOf(this);
            -1 != c && Cells.splice(c, 1);
          }
          this.x = a * (this.nx - this.ox) + this.ox;
          this.y = a * (this.ny - this.oy) + this.oy;
          this.size = b * (this.nSize - this.oSize) + this.oSize;
          return b;
        },
        getDisplayName: function () {
          if (this.owner && this.owner.team !== undefined) {
            return "[" + (this.owner.team + 1) + "] " + this.name;
          }
          return this.name;
        },
        shouldRender: function () {
          if (0 == this.id) {
            return true;
          } else {
            return !(
              this.x + this.size + 40 < nodeX - canvasWidth / 2 / viewZoom ||
              this.y + this.size + 40 < nodeY - canvasHeight / 2 / viewZoom ||
              this.x - this.size - 40 > nodeX + canvasWidth / 2 / viewZoom ||
              this.y - this.size - 40 > nodeY + canvasHeight / 2 / viewZoom
            );
          }
        },
        getStrokeColor: function () {
          var r = (~~(parseInt(this.color.substr(1, 2), 16) * 0.9)).toString(16),
            g = (~~(parseInt(this.color.substr(3, 2), 16) * 0.9)).toString(16),
            b = (~~(parseInt(this.color.substr(5, 2), 16) * 0.9)).toString(16);
          if (r.length == 1) r = "0" + r;
          if (g.length == 1) g = "0" + g;
          if (b.length == 1) b = "0" + b;
          return "#" + r + g + b;
        },
        drawOneCell: function (ctx) {
          if (this.shouldRender()) {
            var b =
              0 != this.id &&
              !this.isVirus &&
              !this.isAgitated &&
              smoothRender > viewZoom;
            if (10 > this.getNumPoints()) b = true;
            if (this.wasSimpleDrawing && !b)
              for (var c = 0; c < this.points.length; c++)
                this.points[c].size = this.size;
            var bigPointSize = this.size;
            if (!this.wasSimpleDrawing) {
              for (var c = 0; c < this.points.length; c++)
                bigPointSize = Math.max(this.points[c].size, bigPointSize);
            }
            this.wasSimpleDrawing = b;
            ctx.save();
            this.drawTime = timestamp;
            c = this.updatePos();
            this.destroyed && (ctx.globalAlpha *= 1 - c);
            ctx.lineWidth = 10;
            ctx.lineCap = "round";
            ctx.lineJoin = this.isVirus ? "miter" : "round";
            if (showColor) {
              ctx.fillStyle = "#FFFFFF";
              ctx.strokeStyle = "#AAAAAA";
            } else {
              ctx.fillStyle = this.color;
              if (b) ctx.strokeStyle = this.getStrokeColor();
              else ctx.strokeStyle = this.color;
            }
            ctx.beginPath();
            if (b) {
              var lw = this.size * 0.03;
              ctx.lineWidth = lw;
              ctx.arc(
                this.x,
                this.y,
                this.size - lw * 0.5 + 5,
                0,
                2 * Math.PI,
                false
              );
              //ctx.stroke();
            } else {
              this.movePoints();
              ctx.beginPath();
              var d = this.getNumPoints();
              ctx.moveTo(this.points[0].x, this.points[0].y);
              for (c = 1; c <= d; ++c) {
                var e = c % d;
                ctx.lineTo(this.points[e].x, this.points[e].y); //Draw circle of cell
              }
            }
            ctx.closePath();
            let skinName = this.name.toLowerCase();
            let loadBub = -1;
            if (this.gid && this.gid > 0) {
              loadBub = this.gid;
            }
            if (loadBub != -1) {
              if (skins[this.gid] && skins[this.gid].skin !== this.gid) {
                delete skins[this.gid];
              }
              if (showSkin && this.gid) {
                if (!skins.hasOwnProperty(this.gid)) {
                  skins[this.gid] = new Image();
                  skins[this.gid].crossOrigin = "Anonymous";

                  skins[this.gid].onerror = function () {
                    delete skins[this.gid];
                  };

                  if (loadBub > 100000000) {
                    skins[this.gid].src = "./skins/" + this.gid + ".png";
                  } else if (loadBub >= 10 && loadBub <= 20) {
                    skins[this.gid].src = "./skins/ranks/" + this.gid + ".png";
                  } else {
                    skins[this.gid].src = "./skins/clans/" + this.gid + ".png";
                  }
                  skins[this.gid].skin = loadBub;
                }
              }

              if (
                skins[this.gid] &&
                skins[this.gid].complete &&
                skins[this.gid].naturalWidth !== 0
              ) {
                c = skins[this.gid];
              } else {
                c = null;
              }
            } else {
              c = null;
            }

            b || ctx.stroke();
            ctx.fill(); //Draw cell content
            if (c) {
              ctx.save();
              ctx.clip();
              //Draw skin
              ctx.drawImage(
                c,
                this.x - bigPointSize,
                this.y - bigPointSize,
                2 * bigPointSize,
                2 * bigPointSize
              );
              ctx.restore();
            }
            if ((showColor || 15 < this.size) && !b) {
              ctx.strokeStyle = "#000000";
              ctx.globalAlpha *= 0.1;
              ctx.stroke();
            }
            ctx.globalAlpha = 1;
            c = -1 != cp.indexOf(this);
            var ncache;
            //draw name
            if (0 != this.id) {
              var x = ~~this.x,
                y = ~~this.y,
                nz = this.getNameSize(),
                ratio = Math.ceil(10 * viewZoom) * 0.1,
                ratD = 1 / ratio;
                if (
                  showName &&
                  this.name &&
                  this.nameCache &&
                  (null == e || -1 == knownNameDict_noDisp.indexOf(skinName))
                 ) {
                ncache = this.nameCache;
                ncache.setValue(this.name);
                ncache.setSize(nz);
                ncache.setScale(ratio);
                var rnchache = ncache.render(),
                  m = ~~(rnchache.width * ratD),
                  h = ~~(rnchache.height * ratD);
                ctx.drawImage(rnchache, x - ~~(m * 0.5), y - ~~(h * 0.5), m, h);
                b += rnchache.height * 0.5 * ratio + 4;
              }

              if (
                (showMass && c) ||
                (showOthersMass &&
                  !c &&
                  (!this.isVirus || this.isAgitated) &&
                  20 < this.size)
              ) {
                var m = ~~(this.size * this.size * 0.01);
                c = this.sizeCache;
                c.setValue(m);
                c.setScale(ratio);
                e = c.render();
                m = ~~(e.width * ratD);
                h = ~~(e.height * ratD);
                var g = this.name ? y + ~~(h * 0.7) : y - ~~(h * 0.5);
                ctx.drawImage(e, x - ~~(m * 0.5), g, m, h);
              }
            }
            ctx.restore();
          }
        },
      };
      UText.prototype = {
        _value: "",
        _color: "#000000",
        _stroke: false,
        _strokeColor: "#000000",
        _size: 16,
        _canvas: null,
        _ctx: null,
        _dirty: false,
        _scale: 1,
        setSize: function (a) {
          if (this._size != a) {
            this._size = a;
            this._dirty = true;
          }
        },
        setScale: function (a) {
          if (this._scale != a) {
            this._scale = a;
            this._dirty = true;
          }
        },
        setStrokeColor: function (a) {
          if (this._strokeColor != a) {
            this._strokeColor = a;
            this._dirty = true;
          }
        },
        setValue: function (a) {
          if (a != this._value) {
            this._value = a;
            this._dirty = true;
          }
        },
        render: function () {
          if (null == this._canvas) {
            this._canvas = document.createElement("canvas");
            this._ctx = this._canvas.getContext("2d");
          }
          if (this._dirty) {
            this._dirty = false;
            var canvas = this._canvas,
              ctx = this._ctx,
              value = this._value,
              scale = this._scale,
              fontsize = this._size,
              font = fontsize + "px Ubuntu";
            ctx.font = font;
            var h = ~~(0.2 * fontsize),
              wd = fontsize * 0.1;
            var h2 = h * 0.5;
            canvas.width = ctx.measureText(value).width * scale + 3;
            canvas.height = (fontsize + h) * scale;
            ctx.font = font;
            ctx.globalAlpha = 1;
            ctx.lineWidth = wd;
            ctx.strokeStyle = this._strokeColor;
            ctx.fillStyle = this._color;
            ctx.scale(scale, scale);
            this._stroke && ctx.strokeText(value, 0, fontsize - h2);
            ctx.fillText(value, 0, fontsize - h2);
          }
          return this._canvas;
        },
        getWidth: function () {
          return ctx.measureText(this._value).width + 6;
        },
      };
      Date.now ||
        (Date.now = function () {
          return new Date().getTime();
        });
      var Quad = {
        init: function (args) {
          function Node(x, y, w, h, depth) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = h;
            this.depth = depth;
            this.items = [];
            this.nodes = [];
          }

          var c = args.maxChildren || 2,
            d = args.maxDepth || 4;
          Node.prototype = {
            x: 0,
            y: 0,
            w: 0,
            h: 0,
            depth: 0,
            items: null,
            nodes: null,
            exists: function (selector) {
              for (var i = 0; i < this.items.length; ++i) {
                var item = this.items[i];
                if (
                  item.x >= selector.x &&
                  item.y >= selector.y &&
                  item.x < selector.x + selector.w &&
                  item.y < selector.y + selector.h
                )
                  return true;
              }
              if (0 != this.nodes.length) {
                var self = this;
                return this.findOverlappingNodes(selector, function (dir) {
                  return self.nodes[dir].exists(selector);
                });
              }
              return false;
            },
            retrieve: function (item, callback) {
              for (var i = 0; i < this.items.length; ++i) callback(this.items[i]);
              if (0 != this.nodes.length) {
                var self = this;
                this.findOverlappingNodes(item, function (dir) {
                  self.nodes[dir].retrieve(item, callback);
                });
              }
            },
            insert: function (a) {
              if (0 != this.nodes.length) {
                this.nodes[this.findInsertNode(a)].insert(a);
              } else {
                if (this.items.length >= c && this.depth < d) {
                  this.devide();
                  this.nodes[this.findInsertNode(a)].insert(a);
                } else {
                  this.items.push(a);
                }
              }
            },
            findInsertNode: function (a) {
              return a.x < this.x + this.w / 2
                ? a.y < this.y + this.h / 2
                  ? 0
                  : 2
                : a.y < this.y + this.h / 2
                ? 1
                : 3;
            },
            findOverlappingNodes: function (a, b) {
              return (a.x < this.x + this.w / 2 &&
                ((a.y < this.y + this.h / 2 && b(0)) ||
                  (a.y >= this.y + this.h / 2 && b(2)))) ||
                (a.x >= this.x + this.w / 2 &&
                  ((a.y < this.y + this.h / 2 && b(1)) ||
                    (a.y >= this.y + this.h / 2 && b(3))))
                ? true
                : false;
            },
            devide: function () {
              var a = this.depth + 1,
                c = this.w / 2,
                d = this.h / 2;
              this.nodes.push(new Node(this.x, this.y, c, d, a));
              this.nodes.push(new Node(this.x + c, this.y, c, d, a));
              this.nodes.push(new Node(this.x, this.y + d, c, d, a));
              this.nodes.push(new Node(this.x + c, this.y + d, c, d, a));
              a = this.items;
              this.items = [];
              for (c = 0; c < a.length; c++) this.insert(a[c]);
            },
            clear: function () {
              for (var a = 0; a < this.nodes.length; a++) this.nodes[a].clear();
              this.items.length = 0;
              this.nodes.length = 0;
            },
          };
          var internalSelector = {
            x: 0,
            y: 0,
            w: 0,
            h: 0,
          };
          return {
            root: new Node(
              args.minX,
              args.minY,
              args.maxX - args.minX,
              args.maxY - args.minY,
              0
            ),
            insert: function (a) {
              this.root.insert(a);
            },
            retrieve: function (a, b) {
              this.root.retrieve(a, b);
            },
            retrieve2: function (a, b, c, d, callback) {
              internalSelector.x = a;
              internalSelector.y = b;
              internalSelector.w = c;
              internalSelector.h = d;
              this.root.retrieve(internalSelector, callback);
            },
            exists: function (a) {
              return this.root.exists(a);
            },
            clear: function () {
              this.root.clear();
            },
          };
        },
      };
      wjQuery(function () {
        function renderFavicon() {
          if (0 < cp.length) {
            redCell.color = cp[0].color;
            redCell.setName(cp[0].name);
          }
          ctx.clearRect(0, 0, 32, 32);
          ctx.save();
          ctx.translate(16, 16);
          ctx.scale(0.4, 0.4);
          redCell.drawOneCell(ctx);
          ctx.restore();
          var favicon = document.getElementById("favicon"),
            oldfavicon = favicon.cloneNode(true);
          oldfavicon.setAttribute("href", favCanvas.toDataURL("image/png"));
          favicon.parentNode.replaceChild(oldfavicon, favicon);
        }

        var redCell = new Cell(0, 0, 0, 32, "#ED1C24", ""),
          favCanvas = document.createElement("canvas");
        favCanvas.width = 32;
        favCanvas.height = 32;
        var ctx = favCanvas.getContext("2d");
        renderFavicon();

        // Causes stuttering..
        //setInterval(renderFavicon, 1E3);

        setInterval(drawChatBoard, 1e3);
      });
      wHandle.onload = gameLoop;

          var x = []
                , Qa = 0
                , Ra = "#000000"
                , U = !1
                , Sa = !1
                , sb = 0
                , tb = 0
                , Ua = 0
                , Ta = 0
                , S = 0
            setInterval(function() {
                Sa && x.push(calcUserScore() / 100)
            }, 1E3 / 60);
            setInterval(function() {
                var a = cc();
                0 != a && (++Ua, 0 == S && (S = a), S = Math.min(S, a))
            }, 1E3);
            wHandle.closeStats = function() {
            U = 0;
            wjQuery("#formStd").show();
            window.location.hash = '#home';
            };
      })(window, window.jQuery);
    </script>
    <script>
      var logged = 1;
    </script>
  </head>

  <body class="">
    <div class="modal fade" id="inPageModal" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              
            </button>
            <h4 id="inPageModalTitle" class="modal-title">Failed to Load</h4>
          </div>
          <div id="inPageModalBody" class="modal-body">
            <p>Failed to load. Please check your connection!</p>
            <div class="center">
              <div class="loader"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="overlays" style="position: absolute; inset: 0px; z-index: 200; display: none; background-color: rgba(0, 0, 0, 0.498);" class="">
      <div id="helloContainer" style="transform: translate(-50%, -50%)">
        <div id="helloDialog">
          <div id="formStd" style="display: block;">
            <form role="form" data-gtm-form-interact-id="0">
              <div class="form-group">
                <div style="float: left; margin-left: 20px">
                  <h2>Boobble.am <span style="color: red;">[BETA]</span></h2>
                </div>
                <br style="clear: both">
              </div>

              <div class="form-group" style="margin-bottom: 5px !important">
                <input id="nick" class="form-control" value="A F F" readonly="">
                <select id="gamemode" class="form-control" required="" data-gtm-form-interact-field-id="0">
                  <option value=":5">FFA</option>
                  <option value=":9">Clan Wars</option>
                  <option value=":2">Experimental</option>
                  <option value=":11">Battle</option>
                </select>
                <br clear="both">
                <div id="radio_mode" style="display: block;">
                  <div class="radio-ffa" style="text-align: center; display: none;">
                    <input id="radio_mode_5" name="mode_type" type="radio" value="5" checked="">
                    <label for="radio_mode_5" id="mode5click" class="gm-s">5x</label>
                    <input type="radio" name="mode_type" id="radio_mode_7" value="7">
                    <label for="radio_mode_7" class="gm-s">Hardcore</label>
                  </div>
                  <div class="radio-battle" style="text-align: center; display: block;">
                    <input id="radio_mode_12" name="mode_type" type="radio" value="12">
                    <label class="gm-s" for="radio_mode_12">Battle 1v1</label>
                    <input id="radio_mode_11" name="mode_type" type="radio" value="11" data-gtm-form-interact-field-id="1">
                    <label class="gm-s" for="radio_mode_11">Battle 2v2</label>
                    <button class="btn btn-success" id="battle-spect" onclick="$(&#39;#battle-live&#39;).modal(&#39;toggle&#39;); return false;">
                      Spectate
                    </button>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <button type="submit" id="playBtn" style="width: 86%;" class="btn btn-play btn-needs-server btn-danger"><span class="spinner"><i class="fa fa-spinner fa-spin"></i></span> Play</button>
                <button type="submit" class="btn btn-success showFriends" data-friends="normal" style="margin-left: 3px; display: none;">
                  <i class="fa fa-user-plus"></i>
                </button>
                <button onclick="$(&#39;#settings, #instructions&#39;).toggle(); return false;" class="btn btn-info btn-settings" id="settings-btn">
                  <i class="fa fa-cog"></i>
                </button>
                <br clear="both">
              </div>
            </form>

            <div id="instructions">
              <center style="margin-bottom: 20px">
                <span class="text-muted">
  Mueve el ratn para controlar tu clula<br>
  Presiona <b>Espacio</b> para dividir<br>
  Presiona <b>W, E (auto)</b> para expulsar masa<br>
</span>
              </center>
            </div>

            <div id="settings" style="display: none">
              <div class="form-group" id="mainform">
                <div id="locationKnown">
                  <select id="region" class="form-control" onchange="setRegion($(this).val());" required="">
  <option disabled="" value="0">-- Selecciona una Regin --</option>
  <option value="1">Europa (76 jugadores)</option>
  <option value="3">Norte y Sur Amrica (0 jugadores)</option>
  <option value="4">Oceana (0 jugadores)</option>
</select>
<button id="spectateBtn" onclick="spectate(); return false;" class="btn btn-warning btn-spectate btn-needs-server">
  Espectar
</button>
                  <br clear="both">
                </div>
              </div>

              <div class="settings_checkboxes">
  <label><input type="checkbox" class="save" data-box-id="1" onchange="setSkins(!$(this).is(':checked'));">
    Sin skins</label>
  <label><input type="checkbox" class="save" data-box-id="2" onchange="setNames(!$(this).is(':checked'));">
    Sin nombres</label>
  <label><input type="checkbox" class="save" data-box-id="3" onchange="setDarkTheme($(this).is(':checked'));">
    Tema oscuro</label>
  <label><input type="checkbox" class="save" data-box-id="4" onchange="setColors($(this).is(':checked'));">
    Sin colores</label>
  <label><input type="checkbox" class="save" data-box-id="5" onchange="displayChat($(this).is(':checked'));">
    Chat</label>
  <label><input type="checkbox" class="save" data-box-id="6" onchange="setShowMass($(this).is(':checked'));">
    Mostrar masa</label>
  <label><input type="checkbox" class="save" data-box-id="7" onchange="setShowOthersMass($(this).is(':checked'));">
    Mostrar masa de otros</label>
  <label><input type="checkbox" class="save" data-box-id="8" onchange="setShowBorder($(this).is(':checked'));">
    Mostrar borde</label>
  <label><input type="checkbox" class="save" data-box-id="9" onchange="setNoGrid($(this).is(':checked'));">
    Sin cuadrcula</label>
</div>

              <br><br><br>
              <center style="margin-bottom: 10px; display: none;" id="fDza">
                <span class="text-muted">
  Usa el siguiente enlace para jugar con amigos
  <input onmouseover="this.select();" class="form-control" id="friendsZone" value="">
</span>
              </center>
            </div>
            <hr>

            <div id="escapingLEVEL" style="width: 316px; margin: 0 auto">
              <div id="escapingBallG" style="display: none">
                <div class="escapingBallG"></div>
              </div>
              <div style="position: relative" class="clearfix">
                <div class="exp-bar progress">
                  <span class="progress-bar-text">
                    0/208
                    XP
                  </span>
                  <div class="progress-bar progress-bar-striped" style="
                      width: 1%;
                    "></div>
                </div>
                <div class="progress-bar-star">1</div>
              </div>
            </div>
          </div>

          <div id="loadPage" style="opacity: 1; display: none;"><div class="title" style="transform: translateY(0px)">
    <a href="https://monacomobile.ct.ws/#" id="load_home">Boobble.am</a>  Notifications
  </div>
  
  <div class="bub-table-list m-t-10" id="notifications-list" style="overflow-y: auto; height: 390px; margin-bottom: 10px;">
    <div class="user-notif">
      
    </div>
  </div>
  <script> 
  function dn(el) {
      const id = el.parentElement.dataset.id;
      $.post('/dn', { id }, () => {
        $(el.parentElement).remove();
      });
    } 
</script>

  <style>
    #loadPage {
       min-height: 420px;
    }
    .user-notif .notification {
       padding: 8px 3px 8px 5px;
       border-bottom: 1px solid #efefef;
       position: relative;
       background-color: #fff;
    }
    .user-notif .notification:hover {
        border-left: 1px solid #e8a100!important;
        cursor: pointer;
    }

    .user-notif .notification.first {
        border-left: 1px solid #e8a100!important;
    }

    .user-notif div {
        padding: 8px 3px 8px 5px;
        border-bottom: 1px solid #efefef;
        position: relative;
    }
    .user-notif div:hover,.user-notif div.odd {
        border-left: 1px solid #e8a100!important;
        cursor: pointer;
    }
    .user-notif div.info {
        background-color: #fff;
    }
    .user-notif div.warning {
        background-color: #ffefef;
    }
    .user-notif span.nick {
        font-weight: 700;
        color: #6b8eca;
    }
  </style></div>
          <audio id="photography_audio">
            <source src="sounds/bump.mp3" type="audio/mpeg">
          </audio>
          <audio id="connect_audio">
            <source src="sounds/connected.mp3" type="audio/mpeg">
          </audio>
          <audio id="alert_audio">
            <source src="sounds/alert.mp3" type="audio/mpeg">
          </audio>
          <div id="stats" style="display: none">
            <h2><center>Match Results</center></h2>
            <canvas id="statsGraph" width="320" height="230"></canvas>
            <div id="statsPelletsContainer">
              <span id="statsText" class="stats-food-eaten"></span>
              <span id="statsSubtext">food eaten</span>
            </div>
            <div id="statsHighestMassContainer">
              <span id="statsText" class="stats-highest-mass"></span>
              <span id="statsSubtext">highest mass</span>
            </div>
            <div id="statsTimeAliveContainer">
              <span id="statsText" class="stats-time-alive"></span>
              <span id="statsSubtext">time alive</span>
            </div>
            <div id="statsTimeLeaderboardContainer">
              <span id="statsText" class="stats-leaderboard-time"></span>
              <span id="statsSubtext">leaderboard time</span>
            </div>
            <div id="statsPlayerCellsEatenContainer">
              <span id="statsText" class="stats-cells-eaten"></span>
              <span id="statsSubtext">cells eaten</span>
            </div>
            <div id="statsTopPositionContainer">
              <span id="statsText" class="stats-top-position">?</span>
              <span id="statsSubtext">top position</span>
            </div>
            <div class="center">
              <a class="btn btn-primary" style="width: 100%" href="https://monacomobile.ct.ws/#" onclick="closeStats();">Back</a>
            </div>
          </div>
          <div id="footer" class="center">
            <a class="_menu homebtn active" href="https://monacomobile.ct.ws/#" id="load_home">Home</a> |
            <a class="_menu" href="/bubble.am_files/account.html">#account" id="load_account">Account</a>
            <div class="btn-group dropup">
              |
              <a class="_menu" href="https://monacomobile.ct.ws/#" data-toggle="dropdown" aria-expanded="false">Community</a>
              <ul class="dropdown-menu">
                <li class="dropdown-submenu">
                  <a href="/bubble.am_files/friends.html"><i class="fa fa-users"></i>Friends</a>
                </li>
                <li class="dropdown-submenu">
                  <a href="/bubble.am_files/notifications.html"><i class="fa fa-bell"></i>Notifications</a>
                </li>
                <li class="dropdown-submenu">
                  <a href="/bubble.am_files/highscore.html">"><i class="fa fa-area-chart"></i>Highscore</a>
                </li>
                <li class="dropdown-submenu">
                  <a href="/bubble.am_files/html.html"><i class="fa fa-institution"></i>Guilds</a>
                </li>
                
              </ul>
            </div>
            <div class="btn-group dropup">
              |
              <a class="_menu" href="https://monacomobile.ct.ws/#" data-toggle="dropdown" aria-expanded="false">About</a>
              <ul class="dropdown-menu">
                <li>
                  <a href="https://monacomobile.ct.ws/#" onclick="alert(&#39;Discord: https://discord.gg/TVVXqghX7w&#39;)">Contact</a>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="side-container">
          <div class="modal-content friends-online" style="display: none;">
            <div class="modal-header">
              <h4 class="modal-title">
                Invite friends to<span class="friends-modal-mode" style="margin-left: 5px">
                  {SERVERMODE}
                </span>
              </h4>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <div class="bub-table-list m-t-10" id="friends-view-modal-data">
                  <h2 class="center" style="color: silver; font-size: 20px; display: none;">
                    0 friends online
                  </h2>
                  <table class="table table-striped table-hover"><tbody><tr class="inviteplayer_7467 tr-disabled" data-player="1411" style="border-bottom: 1px solid #eee">
                <td style="text-align: left; width: 15%; border-top: none; position: relative;">
                    <span class="img-circle friends-circle" style="background-color:rgba(65,177,54,0.7);">
                        A
                    </span>
                </td>
                <td style="width: 65%; border-top: none; padding-top: 10px;" data-player="1411">
                  <span style="display: inline-block">AlmeZz</span>
                </td>
                <td style="width: 10%; text-align: center; border-top: none; padding-top: 10px;">
                    S3Xi
                </td>
                <td style="width: 10%; text-align: center; border-top: none; padding-top: 10px;" class="d-online"><i class="fa fa-gamepad"></i></td>
              </tr></tbody></table>
                </div>
                <table class="table">
                  <tbody>
                    <tr>
                      <td colspan="4" style="text-align: center">
                        <a href="https://monacomobile.ct.ws/#friends"><i class="fa fa-users"></i> Friends</a>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addFriendModal" role="dialog">
      <div class="modal-dialog" style="width: 350px">
        <div class="modal-content" style="height: 230px">
          <div class="modal-header" style="border: none">
            <button type="button" class="close" data-dismiss="modal">
              
            </button>
            <h4 class="modal-title" style="font-weight: 700">Invite player</h4>
          </div>
          <div class="modal-body" style="padding: 10px; border: none">
            <input type="text" class="i-name form-control" placeholder="Player name" style="margin-bottom: 10px">
            <textarea class="i-msg form-control" placeholder="Message (optional)" style="height: 56px"></textarea>
          </div>
          <div class="modal-footer" style="padding: 10px; border: none">
            <button type="button" class="i-send btn btn-primary btn-block">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="invitePlayerModal" role="dialog">
      <div class="modal-dialog" style="width: 350px">
        <div class="modal-content" style="height: 170px">
          <div class="modal-header" style="border: none">
            <button type="button" class="close" data-dismiss="modal">
              
            </button>
            <h4 class="modal-title" style="font-weight: 700">Invite player</h4>
          </div>
          <div class="modal-body" style="padding: 10px; border: none">
            <input type="text" id="invitePlayer" class="form-control" placeholder="Player name">
          </div>
          <div class="modal-footer" style="padding: 10px; border: none">
            <button type="button" id="btnInvite" class="btn btn-primary btn-block">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="battle-live" style="display: none;" aria-hidden="true">
      <div class="modal-dialog" style="width: 750px">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
              
            </button>
            <h4 class="modal-title">Battle Live</h4>
          </div>
          <div class="modal-body" id="battle-live-data"><table class="table table-striped table-hover"><tbody><tr class="connect" data-srv="monacomobile.ct.ws/wsd/-11-0-1" style="cursor:pointer;"><td class="bli-b"><div style="height:30px;width:40px;opacity:0;"></div></td><td class="fb-lo2g">Jeje suder4jat, chambre</td><td class="pb-lo2g"><strong style="font-size:17px;">0:0</strong><br><span style="color:silver;font-size:11px;">484:36</span></td><td class="sb-lo2g">Kibutsujin, OvO</td><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_13.png"></td></tr><tr class="connect" data-srv="monacomobile.ct.ws/wse/-11-0-1" style="cursor:pointer;"><td class="bli-b"><div style="height:30px;width:40px;opacity:0;"></div></td><td class="fb-lo2g">AGUS TEPOS, P l A N O</td><td class="pb-lo2g"><strong style="font-size:17px;">0:0</strong><br><span style="color:silver;font-size:11px;">179:13</span></td><td class="sb-lo2g">Leniwy, Muzan K1butsuji</td><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_12.png"></td></tr><tr class="connect" data-srv="monacomobile.ct.ws/wsi/-11-0-1" style="cursor:pointer;"><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_15.png"></td><td class="fb-lo2g">muuunik</td><td class="pb-lo2g"><strong style="font-size:17px;">1:1</strong><br><span style="color:silver;font-size:11px;">12:33</span></td><td class="sb-lo2g">TobiGames</td><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_11.png"></td></tr><tr class="connect" data-srv="monacomobile.ct.ws/wsq/-11-0-1" style="cursor:pointer;"><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_14.png"></td><td class="fb-lo2g">Lunaris</td><td class="pb-lo2g"><strong style="font-size:17px;">2:1</strong><br><span style="color:silver;font-size:11px;">05:42</span></td><td class="sb-lo2g">Razor</td><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_11.png"></td></tr><tr class="connect" data-srv="monacomobile.ct.ws/wsp/-11-0-1" style="cursor:pointer;"><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_11.png"></td><td class="fb-lo2g">Brazzer, Adendabeth</td><td class="pb-lo2g"><strong style="font-size:17px;">1:0</strong><br><span style="color:silver;font-size:11px;">00:44</span></td><td class="sb-lo2g">SERANGINAJA, Heavenly</td><td class="bli-b"><div style="height:30px;width:40px;opacity:0;"></div></td></tr><tr class="connect" data-srv="monacomobile.ct.ws/wso/-11-0-1" style="cursor:pointer;"><td class="bli-b"><div style="height:30px;width:40px;opacity:0;"></div></td><td class="fb-lo2g">fyltoxrd</td><td class="pb-lo2g"><strong style="font-size:17px;">0:0</strong><br><span style="color:silver;font-size:11px;">00:32</span></td><td class="sb-lo2g">Marsha JKT48</td><td class="bli-b"><img style="height:30px;width:40px;" src="./bubble.am_files/rank_13.png"></td></tr></tbody></table></div>
        </div>
      </div>
    </div>

    <div class="modal" id="tournament-modal" data-battleid="1t3c72jtj5" style="display: none;" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" onclick="bClose()" class="close" data-dismiss="modal">
              
            </button>
            <h4 class="modal-title">Create Battle</h4>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-xs-6">
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <i class="fa fa-cog fa-2"></i> Settings
                  </div>
                  <div class="panel-body">
                    <div class="row">
                      <table class="table" style="margin-bottom: 0">
                        <tbody>
                          <tr>
                            <td class="tright">Mode</td>
                            <td><span class="modeinfo battle-mode">2 vs 2</span></td>
                          </tr>
                          <tr>
                            <td class="tright">Region</td>
                            <td>
                              <span class="modeinfo battle-region">Europe</span>
                            </td>
                          </tr>
                          <tr>
                            <td class="tright">Queue</td>
                            <td>
                              <span class="modeinfo battle-servers">~5 minutes</span>
                              <div id="battleNotify" class="checkbox checkbox-success" style="display: none; margin-left: 15px;">
                                <input id="check_Notify" type="checkbox" onchange="battleNotify($(this).is(&#39;:checked&#39;),12);">
                                <label for="check_Notify">notify</label>
                              </div>
                            </td>
                          </tr>
                          <tr>
                            <td class="tright">Status</td>
                            <td>
                              <span class="modeinfo battle-srvstatus">Starting!</span>
                            </td>
                          </tr>
                          <tr>
                            <td class="tright">Reward</td>
                            <td>
                              <span class="modeinfo battle-reward">1.5 pt.</span>
                            </td>
                          </tr>
                          <tr>
                            <td class="tright">If defeated</td>
                            <td>
                              <span class="modeinfo battle-defeated" style="color: red">0.7 pt. </span>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <i class="fa fa-wechat fa-2"></i> Chat
                  </div>
                  <div class="panel-body" style="padding-bottom: 0">
                    <div class="row">
                      <div class="bub-box-scroll">
                        <input id="battle_chat" class="chat" type="text" name="" placeholder="Message..">
                        <table class="table table-striped chat-table"><tbody><tr><td style="word-break: break-all;"><strong style="color:rgb(65,177,54);">AlmeZz</strong>: en esta acc no pierdo jaja</td></tr></tbody></table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xs-6">
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <i class="fa fa-users fa-2"></i> Players
                    <span class="battle-online">2/2</span>
                  </div>
                  <div class="panel-body">
                    <div class="row">
                      <button id="button-start-battle" class="btn btn-danger has-spinner" style="position: absolute; bottom: 0px; width: 100%; display: none;">
                        <span class="spinner"><i class="fa fa-spinner fa-spin"></i></span>
                        Start
                      </button>
                      <div class="bub-box-scroll">
                        <table class="table table-striped tournament-players"><tbody><tr><td style="text-align:left;width: 15%;"><span class="img-circle friends-circle" style="background-color:rgba(65,177,54,0.7);">A</span></td><td style="width:65%">AlmeZz</td><td><span style="color:green;">56%</span></td><td></td></tr><tr><td style="text-align:left;width: 15%;"><span class="img-circle friends-circle" style="background-color:rgba(52,152,219,0.7);">A</span></td><td style="width:65%">Sin Nombre</td><td><span style="color:green;">85%</span></td><td></td></tr></tbody></table>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <div class="pull-left">
                      <i class="fa fa-user-plus fa-2"></i> Friends
                    </div>
                    <div class="pull-right">
                      <div id="battleNotify11" class="checkbox checkbox-warning" style="display: inline; margin-left: 15px">
                        <input id="check_Notify11" type="checkbox" onchange="battleNotify($(this).is(&#39;:checked&#39;),11);">
                        <label for="check_Notify11">show all invitations</label>
                      </div>
                    </div>
                    <div class="clearfix"></div>
                  </div>
                  <div class="panel-body">
                    <div class="m-b--15">
                      <div class="row">
                        <div class="bub-box-scroll">
                          <div style="padding: 10px; text-align: center; display: none;" id="i8DN">
                            <a href="https://monacomobile.ct.ws/#" onclick="bInvA($(&#39;#tournament-modal&#39;).attr(&#39;data-battleid&#39;)); $(this).parent().hide();">Send invitation to all players</a>
                          </div>
                          <table class="table table-striped table-hover tournament-invite"><tbody><tr class="inviteplayer_7467 tr-disabled" data-player="1411" style="border-bottom: 1px solid rgb(238, 238, 238); opacity: 0.3;">
                <td style="text-align: left; width: 15%; border-top: none; position: relative;">
                    <span class="img-circle friends-circle" style="background-color:rgba(65,177,54,0.7);">
                        A
                    </span>
                </td>
                <td style="width: 65%; border-top: none; padding-top: 10px;" data-player="1411">
                  <span style="display: inline-block">AlmeZz</span>
                </td>
                <td style="width: 10%; text-align: center; border-top: none; padding-top: 10px;">
                    S3Xi
                </td>
                <td style="width: 10%; text-align: center; border-top: none; padding-top: 10px;" class="d-online"><i class="fa fa-gamepad"></i></td>
              </tr></tbody></table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="create-guild-modal">
      <div class="modal-dialog guild-modal">
        <div class="modal-content">
          <form enctype="multipart/form-data">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                
              </button>
              <h4 class="modal-title">Create new Guild</h4>
            </div>

            <div class="modal-body">
              <div style="text-align: center; font-weight: bold">
                Price: 50 Pt.
              </div>

              <div class="form-group">
                <label for="new_guild_prefix" class="control-label">Prefix</label>
                <input name="new_guild_prefix" type="text" id="new_guild_prefix" class="form-control" value="" maxlength="4" title="Only letters, numbers and !@# characters are allowed" required="" pattern="[a-zA-Z0-9\!\@\#]+">
              </div>

              <div class="form-group">
                <label for="new_guild_name" class="control-label">Guild name</label>
                <input name="new_guild_name" type="text" value="" id="new_guild_name" class="form-control" maxlength="20" required="" pattern="[a-zA-Z0-9\!\@\#]+" title="Only letters, numbers and !@# characters are allowed">
              </div>

              <div class="form-group">
                <label for="new_guild_type" class="control-label">Type</label>
                <input type="hidden" name="user_hash" value="704dc72db0d896f2691b5c1c0799f5396d552189">
                <select class="form-control" name="guild_type">
                  <option value="0">Private</option>
                  <option value="1">Public</option>
                </select>
              </div>

              <div class="form-group">
                <label class="control-label">Upload skin</label>
                <input class="form-control" id="new_guild_skin" name="file" type="file" required="">
              </div>

              <div class="form-group center">
                <p style="font-weight: bold; color: #c60000">
                  You can upload only Clip art images.
                </p>
              </div>
            </div>

            <div class="modal-footer">
              <button style="width: 100%" id="new_guild" class="btn btn-primary">
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="connecting" style="display: none;">
      <div style="
          width: 350px;
          background-color: #ffffff;
          margin: 100px auto;
          border-radius: 15px;
          padding: 5px 15px 5px 15px;
        ">
        <h2>Conectando</h2>
<p>
  Si no puedes conectarte a los servidores, verifica si tienes algn antivirus
  o firewall que est bloqueando la conexin.
</p>
      </div>
    </div>

    <canvas id="canvas" width="1536" height="898"></canvas>
    <div id="enableChat" style="z-index: 2147483647; display: inline;">
      <input type="text" id="chat_textbox" style="z-index: 1030; color: black; background: none 0px 0px repeat scroll rgba(0, 0, 0, 0.2);" placeholder="Press enter to chat!" maxlength="200">
      <div id="chatLog" style="z-index: 2147483647; color: black;"><div class="mess_1755254665049 mess_type_0" style="display: none;"><strong style="color:#f15709">[S3Xi] AlmeZz</strong> dog dog rew</div><div class="mess_1755254687304 mess_type_0" style="display: none;"><strong style="color:#f15709">[S3Xi] AlmeZz</strong> run dog</div><div class="mess_1755254693107 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 133ms) HAGGAR killed by AlmeZz</font></div><div class="mess_1755254695778 mess_type_0" style="display: none;"><strong style="color:#f15709">[S3Xi] AlmeZz</strong> dog dog</div><div class="mess_1755254730633 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#666666" style="font-weight: normal">Press 'ctrl' to send message to your teammate.</font><br><font color="#4db2f8">[1] Heavenly has logged in.</font><br><font color="#f15709">[1] SERANGINAJA has logged in.</font><br><font color="#9b2cfa">[2] AlmeZz has logged in.</font><br><font color="#f383fc">[2] A F F has logged in.</font><br><font color="#666666">------------------------</font></div><div class="mess_1755254737557 mess_type_0" style="display: none;"><strong style="color:#9b2cfa">[S3Xi] AlmeZz</strong> <b><font color="#FFA500">dos manos 2:0 como ninada</font></b></div><div class="mess_1755254752150 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 180ms) Heavenly killed by AlmeZz</font></div><div class="mess_1755254754126 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 160ms) AlmeZz killed by A F F</font></div><div class="mess_1755254823421 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <span style="color: #FF0000">You need Premium, price - 2 points.</span></div><div class="mess_1755254848092 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#666666" style="font-weight: normal">Press 'ctrl' to send message to your teammate.</font><br><font color="#4db2f8">[1] Heavenly has logged in.</font><br><font color="#f15709">[1] SERANGINAJA has logged in.</font><br><font color="#9b2cfa">[2] AlmeZz has logged in.</font><br><font color="#f383fc">[2] A F F has logged in.</font><br><font color="#666666">------------------------</font></div><div class="mess_1755254855239 mess_type_0" style="display: none;"><strong style="color:#f383fc">[S3Xi] A F F</strong> <b><font color="#FFA500">f5 eso we</font></b></div><div class="mess_1755254858510 mess_type_0" style="display: none;"><strong style="color:#9b2cfa">[S3Xi] AlmeZz</strong> <b><font color="#FFA500">ez</font></b></div><div class="mess_1755254864756 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 180ms) Heavenly killed by AlmeZz</font></div><div class="mess_1755254866014 mess_type_0" style="display: none;"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 0ms) SERANGINAJA killed by A F F</font></div><div class="mess_1755254892709 mess_type_0"><strong style="color:#ff0000"></strong> <font color="#666666" style="font-weight: normal">Press 'ctrl' to send message to your teammate.</font><br><font color="#4db2f8">[1] Heavenly has logged in.</font><br><font color="#f15709">[1] SERANGINAJA has logged in.</font><br><font color="#9b2cfa">[2] A F F has logged in.</font><br><font color="#f383fc">[2] AlmeZz has logged in.</font><br><font color="#666666">------------------------</font></div><div class="mess_1755254898563 mess_type_0"><strong style="color:#f383fc">[S3Xi] AlmeZz</strong> <b><font color="#FFA500">ya no mas ._.</font></b></div><div class="mess_1755254909510 mess_type_0"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 179ms) Heavenly killed by A F F</font></div><div class="mess_1755254910167 mess_type_0"><strong style="color:#ff0000"></strong> <font color="#808080">(p: 166ms) AlmeZz killed by A F F</font></div><div class="mess_1755254916094 mess_type_0"><strong style="color:#f383fc">[S3Xi] AlmeZz</strong> <b><font color="#FFA500">se ve feo xd</font></b></div></div>
    </div>
    <div id="bubbleNotifications"><div id="mess_1755254638779" class="bubble_invite success" style="display: none;"> <i class="fa fa-check-circle-o"></i> Invitation has been successfully sent.</div><div id="mess_1755254639722" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254669988" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254670432" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254709715" class="bubble_invite success" style="display: none;"> <i class="fa fa-check-circle-o"></i> Invitation has been successfully sent.</div><div id="mess_1755254722916" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254781951" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254783096" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254828892" class="bubble_invite success" style="display: none;"> <i class="fa fa-check-circle-o"></i> Invitation has been successfully sent. (11 players)</div><div id="mess_1755254828977" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254846117" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254846563" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254861869" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254889974" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div><div id="mess_1755254890515" class="bubble_invite warning" onclick="setGameMode(&#39;:11&#39;, 1); createBattleServer(12);" style="display: none;"> <i class="fa fa-exclamation-triangle"></i> Player with the same 1v1 rank is waiting for the opponent.</div></div>
    <div id="time2end"></div>
    <div style="font-family: &#39;Ubuntu&#39;">&nbsp;</div>

    <script src="./bubble.am_files/bootstrap.min.js.descarga"></script>
    <script src="./bubble.am_files/bub.js.descarga"></script>
    <script>
      $(document).ready(function () {
        $("#battle-live").on("shown.bs.modal", function () {
          liveBattles(1);
          $("#overlays").css(
            "background",
            "rgba(0, 0, 0, 0) url(assets/img/background.png) no-repeat scroll 0 0"
          );
        });

        $("#battle-live").on("hidden.bs.modal", function () {
          liveBattles(0);
        });

        $("body").on("click", ".showFriends", function (event) {
          event.preventDefault();
          if (currentMode() !== ":10" && currentMode() !== ":11") {
            var curmod = getModeName(currentMode());
            $(".friends-modal-mode").html("<strong>" + curmod + "</strong>");
            $(".friends-online").toggle();
          }
        });

        $("#tournament-modal").on("shown.bs.modal", function () {
          $("#overlays").css(
            "background",
            "rgba(0, 0, 0, 0) url(assets/img/background.png) no-repeat scroll 0 0"
          );
        });

        $("#tournament-modal").on("hidden.bs.modal", function () {
          bClose();
          if ($("#playBtn, #button-start-battle").hasClass("active")) {
            $("#playBtn, #button-start-battle")
              .removeClass("active")
              .prop("disabled", false);
          }
          srvplay = srvInfo();
        });

        $("#button-start-battle").on("click", function () {
          const $this = $(this);
          const lobbyId = $("#tournament-modal").attr("data-battleid");

          bStart(lobbyId);
          $this.toggleClass("active").prop("disabled", true);

          setTimeout(function () {
            $this.toggleClass("active").prop("disabled", false);
          }, 15000);
        });

        $("body").on("click", "[class*='inviteplayer_']", function () {
          const invite_p = $(this).attr("data-player");

          let srvplay;
          if ($("#tournament-modal").hasClass("in")) {
            srvplay =
              "tournament-2vs2:" +
              $("#tournament-modal").attr("data-battleid") +
              ":" +
              invite_p;
          } else {
            srvplay = srvInfo();
          }
          bubbleSend(invite_p, srvplay);
        });
      });
      var dsfsdf;
      var swdfwef = false;

      $(document).on("keydown", function (e) {
        if (e.keyCode == 69) {
          if (swdfwef) {
            return;
          }
          swdfwef = true;
          dsfsdf = setInterval(function () {
            $("body").trigger(
              $.Event("keydown", {
                keyCode: 87,
              })
            );
            $("body").trigger(
              $.Event("keyup", {
                keyCode: 87,
              })
            );
          }, 3);
        }
      });

      $(document).on("keyup", function (e) {
        if (e.keyCode == 69) {
          swdfwef = false;
          clearInterval(dsfsdf);
          return;
        }
      });
    </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96f817d70926b3e3',t:'MTc1NTI1NDYyOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><iframe height="1" width="1" style="position: absolute; top: 0px; left: 0px; border: none; visibility: hidden;" src="./bubble.am_files/saved_resource.html"></iframe><script defer="" src="./bubble.am_files/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;rayId&quot;:&quot;96f817d70926b3e3&quot;,&quot;version&quot;:&quot;2025.8.0&quot;,&quot;r&quot;:1,&quot;token&quot;:&quot;502c0de1a8f0477f8f74e3e37962cff2&quot;,&quot;serverTiming&quot;:{&quot;name&quot;:{&quot;cfExtPri&quot;:true,&quot;cfEdge&quot;:true,&quot;cfOrigin&quot;:true,&quot;cfL4&quot;:true,&quot;cfSpeedBrain&quot;:true,&quot;cfCacheStatus&quot;:true}}}" crossorigin="anonymous"></script>


<audio id="audiomp3" autoplay=""><source src="sounds/connected.mp3" type="audio/mpeg"></audio></body></html>